<h1 class="mb-4">
  <i class="bi bi-receipt me-2"></i>
  Pedido <span class="text-primary">#<%= @order.number %></span>
</h1>
<div class="row mb-4">
  <div class="col-md-4 mb-2">
    <div class="card shadow-sm">
      <div class="card-body">
        <h6 class="card-title text-secondary mb-2">
          <i class="bi bi-person me-1"></i>Cliente
        </h6>
        <p class="mb-0"><%= @order.client.name %></p>
      </div>
    </div>
  </div>
  <div class="col-md-4 mb-2">
    <div class="card shadow-sm">
      <div class="card-body">
        <h6 class="card-title text-secondary mb-2">
          <i class="bi bi-person-badge me-1"></i>Vendedor
        </h6>
        <p class="mb-0">
          <%= @order.seller.name %>
          <span class="text-muted small">(<%= @order.seller.seller_code %>)</span>
        </p>
      </div>
    </div>
  </div>
  <div class="col-md-4 mb-2">
    <div class="card shadow-sm">
      <div class="card-body">
        <h6 class="card-title text-secondary mb-2">
          <i class="bi bi-flag me-1"></i>Estado
        </h6>
        <% status_class = case @order.status
          when "pending" then "bg-warning text-dark"
          when "in_production" then "bg-info"
          when "ready_for_delivery" then "bg-primary"
          when "delivered" then "bg-success"
          when "cancelled" then "bg-danger"
          else "bg-secondary"
        end %>
        <span class="badge <%= status_class %>">
          <%= @order.status.humanize %>
        </span>
      </div>
    </div>
  </div>
</div>
<h2 class="mt-4 mb-3">
  <i class="bi bi-box-seam me-2"></i>
  Productos del pedido
</h2>
<%# BOTÓN DE CONFIRMAR TODOS LOS PRODUCTOS COMO LISTOS %>
<% if (current_user.production_manager? || current_user.admin?) && @order.order_items.any? { |item| item.in_production? } %>
  <%= button_to "Confirmar todos los productos como listos",
        confirm_all_items_ready_order_path(@order),
        method: :patch,
        data: { confirm: "¿Estás seguro que deseas marcar todos los productos de este pedido como listos para entrega?" },
        class: "btn btn-success mb-3" %>
<% end %>
<div class="table-responsive">
  <table class="table table-striped table-hover align-middle">
    <thead class="table-light">
      <tr>
        <th>Producto</th>
        <th>Cantidad</th>
        <th>Estado de entrega</th>
        <th>Estado en planta</th>
        <th>Notas de producción</th>
        <% if policy(@order).edit? && !@order.delivered? %>
          <th>Acción</th>
        <% end %>
      </tr>
    </thead>
    <tbody>
      <% @order.order_items.each do |item| %>
        <tr>
          <td><strong><%= item.product %></strong></td>
          <td>
            <span class="badge bg-secondary"><%= item.quantity %></span>
          </td>
          <td>
            <span class="badge bg-<%= delivery_item_status_color(item.item_delivery_status) %>">
              <%= DeliveryItem.human_attribute_name("status.#{item.item_delivery_status}") %>
            </span>
          </td>
          <td>
            <% if item.confirmed? %>
              <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Confirmado</span>
            <% else %>
              <span class="badge bg-secondary"><i class="bi bi-hourglass-split me-1"></i>Pendiente de Confirmación</span>
            <% end %>
          </td>
          <td style="min-width: 300px;">
            <%= render "order_item_notes/list", item: item %>
          </td>
          <% if policy(@order).edit? %>
            <% if !@order.delivered? %>
              <td>
                <% if item.confirmed? %>
                  <%= button_to unconfirm_order_item_path(item), method: :patch, class: "btn btn-warning btn-sm", title: "Retirar confirmación" do %>
                    <i class="bi bi-x-circle"></i> Retirar
                  <% end %>
                <% else %>
                  <%= button_to confirm_order_item_path(item), method: :patch, class: "btn btn-primary btn-sm", title: "Confirmar" do %>
                    <i class="bi bi-check-circle"></i> Confirmar
                  <% end %>
                <% end %>
              </td>
            <% end %>
          <% end %>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>
<%= link_to orders_path, class: "btn btn-secondary mt-3" do %>
  <i class="bi bi-arrow-left"></i> Volver a Pedidos
<% end %>
<!-- Estilos adicionales para las notas -->
<style>
  .alert-sm {
    font-size: 0.875rem;
  }

  .dropdown-menu-end {
    --bs-position: end;
  }

  .table td {
    vertical-align: middle;
  }
</style>