<div class="d-flex justify-content-between align-items-center mb-4">
  <h1>
    <i class="bi bi-truck me-2"></i>
    Detalles de Entrega <span class="text-primary">#<%= @delivery.id %></span>
  </h1>
  <% if policy(@delivery).edit? %>
    <%= link_to edit_delivery_path(@delivery), class: "btn btn-sm btn-outline-secondary", title: "Editar" do %>
      <i class="bi bi-pencil-square"></i> Editar
    <% end %>
  <% end %>
</div>
<div class="row mb-4">
  <!-- Información General -->
  <div class="col-md-4 mb-3">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-light">
        <i class="bi bi-info-circle me-1"></i> Información General
      </div>
      <div class="card-body">
        <p>
          <strong><i class="bi bi-calendar-event me-1"></i>Fecha de Entrega:</strong>
          <%= l @delivery.delivery_date, format: :long %>
        </p>
        <p>
          <strong><i class="bi bi-flag me-1"></i>Estado:</strong>
          <span class="badge bg-<%= delivery_status_color(@delivery.status) %>">
            <%= @delivery.display_status %>
          </span>
        </p>
        <p>
          <strong><i class="bi bi-clock me-1"></i>Preferencia de Hora:</strong>
          <%= @delivery.delivery_time_preference.presence || 'No especificado' %>
        </p>
      </div>
    </div>
  </div>
  <!-- Información del Pedido -->
  <div class="col-md-4 mb-3">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-light">
        <i class="bi bi-receipt me-1"></i> Información del Pedido
      </div>
      <div class="card-body">
        <p>
          <strong>Número de Pedido:</strong>
          <%= link_to @delivery.order.number, order_path(@delivery.order), class: "text-decoration-none" %>
        </p>
        <p>
          <strong><i class="bi bi-person me-1"></i>Cliente:</strong>
          <%= @delivery.order.client.name %>
        </p>
        <p>
          <strong><i class="bi bi-person-badge me-1"></i>Vendedor:</strong>
          <%= @delivery.order.seller.name %>
          <span class="text-muted small">(<%= @delivery.order.seller.seller_code %>)</span>
        </p>
      </div>
    </div>
  </div>
  <!-- Dirección de Entrega -->
  <div class="col-md-4 mb-3">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-light">
        <i class="bi bi-geo-alt me-1"></i> Detalles de Entrega
      </div>
      <div class="card-body">
        <p><strong>Dirección:</strong> <%= @delivery.delivery_address.address %></p>
        <% if @delivery.delivery_address.description.present? %>
          <p>
            <strong><i class="bi bi-signpost-2 me-1"></i>Referencia:</strong>
            <%= @delivery.delivery_address.description %>
          </p>
        <% end %>
        <p><strong><i class="bi bi-person-lines-fill me-1"></i>Contacto:</strong> <%= @delivery.contact_name %></p>
        <p><strong><i class="bi bi-telephone me-1"></i>Teléfono Contacto:</strong>
          <%= @delivery.contact_phone.presence || 'No especificado' %>
        </p>
      </div>
    </div>
  </div>
  <!-- Mapa -->
  <div class="col-12 mb-4">
    <div class="card shadow-sm">
      <div class="card-header bg-light">
        <i class="bi bi-map me-1"></i> Ubicación en el mapa
      </div>
      <div class="card-body">
        <% if @delivery.delivery_address.latitude.present? && @delivery.delivery_address.longitude.present? %>
          <div id="delivery-map"
               data-controller="delivery-map"
               style="height: 300px; border:1px solid #ddd; border-radius: 8px;"
               data-lat="<%= @delivery.delivery_address.latitude %>"
               data-lng="<%= @delivery.delivery_address.longitude %>">
          </div>
        <% else %>
          <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            Esta dirección aún no tiene coordenadas registradas.
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>
<!-- Historial de entregas -->
<% if @delivery_history.size > 1 %>
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-light">
      <i class="bi bi-clock-history me-1"></i> Historial de esta entrega
    </div>
    <div class="card-body">
      <div class="accordion" id="deliveryHistoryAccordion">
        <% @delivery_history.each do |d| %>
          <div class="accordion-item">
            <h2 class="accordion-header" id="heading-<%= d.id %>">
              <button class="accordion-button <%= d == @delivery ? '' : 'collapsed' %>" type="button"
                      data-bs-toggle="collapse" data-bs-target="#collapse-<%= d.id %>">
                <%= l d.delivery_date, format: :long %> —
                <span class="badge bg-<%= delivery_status_color(d.status) %>"><%= d.display_status %></span>
                <% if d == @delivery %>
                  <small class="ms-2 text-primary">(actual)</small>
                <% end %>
              </button>
            </h2>
            <div id="collapse-<%= d.id %>" class="accordion-collapse collapse <%= d == @delivery ? 'show' : '' %>"
                 data-bs-parent="#deliveryHistoryAccordion">
              <div class="accordion-body">
                <% if d.delivery_items.any? %>
                  <ul class="list-group list-group-flush">
                    <% d.delivery_items.includes(:order_item).each do |item| %>
                      <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>
                          <strong><%= item.order_item.product %></strong>
                          <% if item.order_item.notes.present? %>
                            <small class="text-muted"> — <%= item.order_item.notes %></small>
                          <% end %>
                        </span>
                        <span>
                          <span class="badge bg-secondary"><%= item.quantity_delivered %></span>
                          <span class="badge bg-<%= delivery_item_status_color(item.status) %>"><%= item.display_status %></span>
                        </span>
                      </li>
                    <% end %>
                  </ul>
                <% else %>
                  <div class="text-muted">Sin productos asociados</div>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
<% end %>
<div class="card shadow-sm mb-4">
  <div class="card-header d-flex justify-content-between align-items-center bg-light">
    <span>
      <i class="bi bi-box-seam me-1"></i> Productos en esta Entrega
    </span>
    <div class="d-flex gap-2 flex-wrap">
      <% unless @delivery.delivered? || @delivery.cancelled? %>
        <%= button_to mark_as_delivered_delivery_path(@delivery),
            method: :patch, class: "btn btn-success btn-sm",
            data: { turbo_confirm: "¿Está seguro de marcar toda la entrega como completada?" } do %>
          Marcar todos los productos como entregados
        <% end %>
      <% end %>
      <%# Confirmar todos los productos %>
      <% if policy(@delivery).edit? && @delivery.delivery_items.any? { |item| item.pending? || item.confirmed? } && !@delivery.delivery_items.all?(&:confirmed?) %>
        <%= button_to confirm_all_items_delivery_path(@delivery),
          method: :patch, class: "btn btn-primary btn-sm",
          data: { turbo_confirm: "¿Estás seguro que deseas confirmar todos los productos para entrega?" } do %>
          <i class="bi bi-check-circle"></i> Confirmar todos los productos
        <% end %>
      <% end %>
      <%# Reagendar toda la entrega %>
      <% if policy(@delivery).edit? && @delivery.delivery_items.any? { |item| !["delivered", "cancelled", "rescheduled"].include?(item.status) } %>
        <div class="d-flex align-items-center gap-2">
          <%= form_with url: reschedule_all_delivery_path(@delivery), method: :patch, class: "d-flex align-items-center gap-2",
                        data: { turbo_confirm: "¿Reagendar toda la entrega para otra fecha?" } do |f| %>
            <% if current_user.role == "seller" %>
              <% next_same_weekday = Date.today + 7.days %>
              <%= f.date_field :new_date, class: "form-control", required: true,
                    value: next_same_weekday.strftime("%Y-%m-%d"),
                    style: "width: 150px;",
                    data: { controller: "weekday-picker",
                            weekday_picker_weekday_value: Date.today.wday,
                            min: next_same_weekday.strftime("%Y-%m-%d") } %>
              <small class="text-muted">
                Solo <%= Date::DAYNAMES[Date.today.wday].downcase %>s
              </small>
            <% else %>
              <%= f.date_field :new_date, class: "form-control", required: true, style: "width: 150px;" %>
            <% end %>
            <%= f.button "Reagendar toda la entrega", class: "btn btn-warning btn-sm" %>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
  <div class="card-body">
    <% if @delivery.delivery_items.any? %>
      <div class="table-responsive">
        <table class="table table-sm table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Producto</th>
              <th>Cantidad</th>
              <th>Observaciones</th>
              <th>Caso Servicio</th>
              <th>Estado</th>
              <th>Notas de producción</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <% @delivery.delivery_items.each do |item| %>
              <tr>
                <td><strong><%= item.order_item.product %></strong></td>
                <td><span class="badge bg-secondary"><%= item.quantity_delivered %></span></td>
                <td>
                  <% if item.order_item.notes.present? %>
                    <span class="text-muted"><i class="bi bi-info-circle"></i> <%= item.order_item.notes %></span>
                  <% else %>
                    <span class="text-muted">N/A</span>
                  <% end %>
                </td>
                <td>
                  <% if item.service_case? %>
                    <span class="badge bg-warning text-dark">Sí</span>
                  <% else %>
                    <span class="badge bg-secondary">No</span>
                  <% end %>
                </td>
                <td>
                  <span class="badge bg-<%= delivery_item_status_color(item.status) %>">
                    <%= item.display_status %>
                  </span>
                </td>
                <td style="min-width: 300px;">
                  <%= render "order_item_notes/list", item: item.order_item %>
                </td>
                <td>
                  <% if item.rescheduled? %>
                    <span class="text-warning">Reagendado</span>
                  <% else %>
                    <% case item.status %>
                    <% when 'pending' %>
                      <%= button_to confirm_delivery_item_path(item), method: :patch, class: "btn btn-primary btn-sm me-1",
                          title: "Confirmar" do %>
                        <i class="bi bi-check-circle"></i> Confirmar
                      <% end %>
                      <button class="btn btn-warning btn-sm" type="button"
                              data-bs-toggle="collapse"
                              data-bs-target="#reschedule-form-<%= item.id %>">
                        <i class="bi bi-calendar2-plus"></i> Reagendar producto
                      </button>
                      <div class="collapse mt-2" id="reschedule-form-<%= item.id %>">
                        <%= render partial: "delivery_items/reschedule_form",
                                   locals: { item: item, future_deliveries: @future_deliveries } %>
                      </div>
                    <% when 'confirmed', 'in_route' %>
                      <%= button_to mark_delivered_delivery_item_path(item), method: :patch,
                          class: "btn btn-success btn-sm me-1",
                          data: { turbo_confirm: "¿Marcar este producto como entregado?" },
                          title: "Marcar entregado" do %>
                        <i class="bi bi-check2-circle"></i> Entregado
                      <% end %>
                      <%= button_to cancel_delivery_item_path(item), method: :patch,
                          class: "btn btn-danger btn-sm",
                          data: { turbo_confirm: "¿Está seguro?" }, title: "Cancelar" do %>
                        <i class="bi bi-x-circle"></i> Cancelar
                      <% end %>
                    <% when 'delivered' %>
                      <span class="text-success"><i class="bi bi-check2-circle"></i> Entregado</span>
                    <% else %>
                      <%= button_to cancel_delivery_item_path(item), method: :patch, class: "btn btn-danger btn-sm",
                          data: { turbo_confirm: "¿Está seguro?" }, title: "Cancelar" do %>
                        <i class="bi bi-x-circle"></i> Cancelar
                      <% end %>
                    <% end %>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <div class="alert alert-info">
        <i class="bi bi-info-circle me-2"></i>
        No hay productos asociados a esta entrega.
      </div>
    <% end %>
  </div>
</div>
<%= link_to (session[:deliveries_return_to] || deliveries_path), class: "btn btn-secondary" do %>
  <i class="bi bi-arrow-left"></i> Volver a Entregas
<% end %>