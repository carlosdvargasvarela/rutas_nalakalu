<div class="col-md-6 mb-3">
  <div class="card h-100 shadow-sm border-0">
    <div class="card-body d-flex flex-column border-start border-5 border-<%= delivery_item_status_color(item.status) %>">
      <h5 class="fw-bold mb-2">
        <i class="bi bi-box"></i> <%= item.order_item.product %>
      </h5>
      <p class="mb-2">
        <span class="badge bg-dark fs-6"><%= item.quantity_delivered %></span>
        <span class="badge bg-<%= delivery_item_status_color(item.status) %> fs-6">
          <%= item.display_status %>
        </span>
        <% if item.service_case? %>
          <span class="badge bg-warning text-dark"><i class="bi bi-tools"></i> Servicio</span>
        <% end %>
      </p>
      <% if item.order_item.notes.present? %>
        <p class="text-muted small mb-2"><i class="bi bi-info-circle"></i> <%= item.order_item.notes %></p>
      <% end %>
      <% unless current_user.seller? %>
        <div class="mb-2">
          <%= render "order_item_notes/list", item: item.order_item %>
        </div>
      <% end %>
      <div class="mt-auto d-flex flex-wrap gap-2">
        <% if delivery.needs_approval? && !delivery.approved? %>
          <span class="text-muted"><i class="bi bi-lock"></i> Bloqueado</span>
        <% elsif item.rescheduled? %>
          <span class="text-warning"><i class="bi bi-calendar-x"></i> Reagendado</span>
        <% elsif item.delivered? %>
          <span class="text-success"><i class="bi bi-check2-circle"></i> Entregado</span>
        <% elsif item.cancelled? %>
          <span class="text-danger"><i class="bi bi-x-circle"></i> Cancelado</span>
        <% else %>
          <!-- ✅ Confirmar -->
          <% if item.pending? %>
            <%= button_to confirm_delivery_item_path(item), method: :patch,
              class: "btn btn-primary btn-sm me-2 mb-2" do %>
              <i class="bi bi-check-circle"></i> Confirmar
            <% end %>
          <% end %>
          <!-- ✅ Entregado (ahora siempre disponible mientras no esté delivered/rescheduled/cancelled) -->
          <%= button_to mark_delivered_delivery_item_path(item), method: :patch,
            class: "btn btn-success btn-sm me-2 mb-2",
            data: { turbo_confirm: "¿Marcar este producto como entregado?" } do %>
            <i class="bi bi-check2-circle"></i> Entregado
          <% end %>
          <!-- Reagendar -->
          <button type="button"
                  class="btn btn-warning btn-sm me-1"
                  data-bs-toggle="modal"
                  data-bs-target="#rescheduleModal<%= item.id %>">
            <i class="bi bi-calendar2-plus"></i> Reagendar
          </button>
          <!-- ❌ Cancelar -->
          <%= button_to cancel_delivery_item_path(item), method: :patch,
            class: "btn btn-outline-danger btn-sm mb-2",
            data: { turbo_confirm: "¿Está seguro?" } do %>
            <i class="bi bi-x-circle"></i> Cancelar
          <% end %>
        <% end %>
      </div>
    </div>
  </div>
</div>