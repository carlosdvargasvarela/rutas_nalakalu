<div class="card shadow-sm mb-4">
  <!-- Header con acciones globales -->
  <div class="sticky-top bg-white border-bottom p-2 d-flex justify-content-between align-items-center" style="z-index: 10;">
    <span>
      <i class="bi bi-box-seam me-1"></i> Productos en esta entrega
    </span>
    <div class="d-flex gap-2 flex-wrap">
      <% if delivery.delivery_items.any? %>
        <button class="btn btn-sm btn-outline-primary"
                                data-bs-toggle="modal"
                                data-bs-target="#notaEntregaModal<%= delivery.id %>">
          <i class="bi bi-sticky"></i> Agregar nota
        </button>
      <% end %>
      <% unless delivery.delivered? || delivery.cancelled? %>
        <%= button_to mark_as_delivered_delivery_path(delivery),
            method: :patch, class: "btn btn-success btn-sm",
            data: { turbo_confirm: "¿Está seguro de marcar toda la entrega como completada?" } do %>
          <i class="bi bi-check-circle-fill"></i> Marcar todos como entregados
        <% end %>
      <% end %>
      <%= link_to new_service_case_for_existing_delivery_path(delivery),
          class: "btn btn-sm btn-warning" do %>
        <i class="bi bi-tools"></i> Caso servicio
      <% end %>
      <% if policy(delivery).edit? && delivery.delivery_items.any? { |item| item.pending? || item.confirmed? } && !delivery.delivery_items.all?(&:confirmed?) %>
        <%= button_to confirm_all_items_delivery_path(delivery),
            method: :patch, class: "btn btn-primary btn-sm",
            data: { turbo_confirm: "¿Confirmar todos los productos?" } do %>
          <i class="bi bi-check-circle"></i> Confirmar todos
        <% end %>
      <% end %>
      <% if policy(delivery).edit? && delivery.delivery_items.any? { |i| !%w[delivered cancelled rescheduled].include?(i.status) } %>
        <!-- Botón que abre modal -->
        <button class="btn btn-warning btn-sm"
                  data-bs-toggle="modal"
                  data-bs-target="#rescheduleModal-<%= delivery.id %>">
          <i class="bi bi-calendar-plus"></i> Reagendar
        </button>
      <% end %>
      <!-- Toggle de vista -->
      <% if params[:view] == "table" %>
        <%= link_to delivery_path(delivery, view: "cards"),
                      class: "btn btn-outline-secondary btn-sm" do %>
          <i class="bi bi-grid-3x3-gap"></i> Vista Cards
        <% end %>
      <% else %>
        <%= link_to delivery_path(delivery, view: "table"),
                      class: "btn btn-outline-secondary btn-sm" do %>
          <i class="bi bi-table"></i> Vista Tabla
        <% end %>
      <% end %>
    </div>
  </div>
  <!-- Body con listado -->
  <div class="card-body">
    <% if delivery.delivery_items.any? %>
      <% if params[:view] == "table" %>
        <%= render "deliveries/show_partials/products_table",
                   delivery: delivery, future_deliveries: future_deliveries %>
      <% else %>
        <%= render "deliveries/show_partials/products_cards",
                   delivery: delivery, future_deliveries: future_deliveries %>
      <% end %>
    <% else %>
      <div class="alert alert-info">
        <i class="bi bi-info-circle me-2"></i> No hay productos asociados.
      </div>
    <% end %>
  </div>
</div>
<%= render "delivery_plans/show_partials/notes", delivery: delivery%>
<%= render "deliveries/shared_partials/reschedule_modal", delivery: delivery %>
<script>
  document.addEventListener("turbo:load", () => {
    document.querySelectorAll("input[data-toggle-fields]").forEach((input) => {
      input.addEventListener("change", (e) => {
        const id = e.target.dataset.toggleFields;
        const isNew = e.target.value === "true";
        const newFields = document.getElementById(`new-date-fields-${id}`);
        const existingFields = document.getElementById(`existing-delivery-fields-${id}`);

        if (!newFields || !existingFields) return;
        newFields.classList.toggle("d-none", !isNew);
        existingFields.classList.toggle("d-none", isNew);
      });
    });
  });
</script>