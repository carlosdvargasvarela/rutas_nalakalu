<%= simple_form_for delivery,
      url: create_service_case_deliveries_path,
      html: {
        data: {
          controller: "delivery-form address-validator",
          "delivery-form-addresses-url-value": addresses_for_client_deliveries_path,
          "delivery-form-orders-url-value": orders_for_client_deliveries_path,
          action: "submit->address-validator#validateBeforeSubmit"
        }
      } do |f| %>
  
  <% if delivery.errors.any? %>
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      <h4 class="alert-heading">Se encontraron <%= pluralize(delivery.errors.count, "error", "errores") %>:</h4>
      <ul class="mb-0">
        <% delivery.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  <% end %>

  <!-- Cliente -->
  <div class="mb-4">
    <h6 class="text-secondary mb-3">
      <i class="bi bi-person-lines-fill me-2"></i>Cliente
    </h6>
    <%= render "deliveries/upsert_partials/client_fields", f: f, clients: clients, delivery: delivery %>
  </div>

  <!-- Dirección -->
  <div class="mb-4">
    <h6 class="text-secondary mb-3">
      <i class="bi bi-geo-alt me-2"></i>Dirección de servicio
    </h6>
    <div data-controller="address-selector">
      <%= render "deliveries/upsert_partials/address_fields", f: f, addresses: addresses, delivery: delivery %>
    </div>
  </div>

  <!-- Pedido -->
  <div class="mb-4">
    <h6 class="text-secondary mb-3">
      <i class="bi bi-receipt me-2"></i>Pedido
    </h6>
    <%= render "deliveries/upsert_partials/order_fields", f: f, delivery: delivery %>
  </div>

  <!-- Productos -->
  <div class="mb-4">
    <h6 class="text-secondary mb-3 d-flex align-items-center">
      <i class="bi bi-box-seam me-2"></i>Productos
      <span class="ms-2 text-muted small">
        Agrega o edita los productos de este caso de servicio
      </span>
    </h6>
    <%= render "deliveries/upsert_partials/order_items_fields", f: f %>
  </div>

  <!-- Datos del servicio -->
  <div class="mb-4">
    <h6 class="text-secondary mb-3">
      <i class="bi bi-calendar-event me-2"></i>Datos del servicio
    </h6>
    <div class="card shadow-sm">
      <div class="card-body">
        <!-- Tipo de servicio -->
        <div class="mb-3">
          <%= f.input :delivery_type,
              collection: [
                ["Recogida y entrega posterior", "pickup_with_return"],
                ["Solo recogida", "only_pickup"],
                ["Devolución de producto", "return_delivery"],
                ["Reparación en sitio", "onsite_repair"]
              ],
              prompt: "Selecciona el tipo de caso de servicio",
              label: "Tipo de servicio",
              input_html: {
                class: "form-select form-select-lg",
                data: { 
                  controller: "service-type",
                  action: "change->service-type#updateNotice" 
                }
              },
              label_html: { class: "form-label fw-semibold" } %>
          
          <div data-controller="service-type">
            <div data-service-type-target="notice" class="form-text text-secondary mt-2">
              <% selected_type = delivery.delivery_type.presence || params.dig(:delivery, :delivery_type) %>
              <% case selected_type %>
              <% when "pickup_with_return" %>
                <i class="bi bi-arrow-return-right me-1 text-warning"></i>
                Se crearán dos casos: <strong>Recogida</strong> en la fecha indicada y <strong>Devolución</strong> automáticamente <strong>+15 días</strong> después, con los mismos productos.
              <% when "only_pickup" %>
                <i class="bi bi-truck me-1 text-secondary"></i> Solo se registrará la <strong>Recogida</strong>.
              <% when "return_delivery" %>
                <i class="bi bi-arrow-counterclockwise me-1 text-secondary"></i> Registrar una <strong>Devolución</strong>.
              <% when "onsite_repair" %>
                <i class="bi bi-wrench me-1 text-secondary"></i> Registrar una <strong>Reparación en sitio</strong>.
              <% else %>
                <i class="bi bi-info-circle me-1 text-muted"></i> Selecciona el tipo de servicio para ver los detalles.
              <% end %>
            </div>
          </div>
        </div>

        <hr class="my-4">

        <!-- Datos complementarios -->
        <%= render "deliveries/upsert_partials/delivery_data_fields", f: f, delivery: delivery %>
        
        <div class="form-text mt-2">
          <i class="bi bi-calendar2-week me-1"></i>
          Para "Recogida y entrega posterior", la devolución se programará automáticamente <strong>+15 días</strong>.
        </div>
      </div>
    </div>
  </div>

  <!-- Acciones -->
  <div class="d-flex justify-content-end gap-2">
    <%= link_to deliveries_path, class: "btn btn-light border" do %>
      <i class="bi bi-x-circle me-1"></i>Cancelar
    <% end %>
    <button type="submit" 
            class="btn btn-warning"
            data-address-validator-target="submitButton">
      <i class="bi bi-check-circle me-1"></i>Guardar caso de servicio
    </button>
  </div>
<% end %>