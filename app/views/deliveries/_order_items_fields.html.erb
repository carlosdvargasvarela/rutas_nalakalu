<%# app/views/deliveries/_order_items_fields.html.erb %>
<% delivery = f.object %>
<div id="delivery-items-container" class="mb-4">
  <div class="row mb-3">
    <div class="col-12">
      <h5 class="text-secondary mb-3">
        <i class="bi bi-box me-2"></i>Productos de la entrega
      </h5>
    </div>
  </div>
  <%# Headers %>
  <div class="row mb-2">
    <div class="col-md-4"><strong>Producto</strong></div>
    <div class="col-md-2"><strong>Cantidad</strong></div>
    <div class="col-md-2"><strong>A entregar</strong></div>
    <div class="col-md-3"><strong>Notas</strong></div>
    <div class="col-md-1"><strong>Acción</strong></div>
  </div>
  <%# Items existentes (solo en edit) %>
  <%= f.simple_fields_for :delivery_items do |di_f| %>
    <div class="delivery-item-row row mb-2">
      <%= di_f.hidden_field :id %>
      <div class="col-md-4">
        <%= di_f.simple_fields_for :order_item do |oi_f| %>
          <%= oi_f.hidden_field :id %>
          <%= oi_f.input :product, label: false, placeholder: "Nombre del producto", 
              input_html: { class: "form-control" } %>
        <% end %>
      </div>
      <div class="col-md-2">
        <%= di_f.simple_fields_for :order_item do |oi_f| %>
          <%= oi_f.input :quantity, label: false, placeholder: "Cantidad", 
              input_html: { class: "form-control", min: 1 } %>
        <% end %>
      </div>
      <div class="col-md-2">
        <%= di_f.input :quantity_delivered, label: false, placeholder: "A entregar", 
            input_html: { class: "form-control", min: 1 } %>
      </div>
      <div class="col-md-3">
        <%= di_f.simple_fields_for :order_item do |oi_f| %>
          <%= oi_f.input :notes, label: false, placeholder: "Notas (opcional)", 
              input_html: { class: "form-control", rows: 1 } %>
        <% end %>
      </div>
      <% unless delivery.persisted? %>
        <div class="col-md-1 d-flex align-items-center">
          <%= link_to "×", "#", class: "btn btn-outline-danger btn-sm", 
            data: { action: "click->delivery-form#removeDeliveryItem" } %>
          <%= di_f.hidden_field :_destroy, class: "destroy-flag" %>
        </div>
      <% end %>
    </div>
  <% end %>
  <%# Template para nuevos items (oculto) %>
  <div class="delivery-item-template delivery-item-row row mb-2" style="display:none;">
    <div class="col-md-4">
      <input class="form-control" placeholder="Producto" name="delivery[delivery_items_attributes][NEW_RECORD][order_item_attributes][product]" />
    </div>
    <div class="col-md-2">
      <input class="form-control" placeholder="Cantidad" type="number" min="1" value="1" name="delivery[delivery_items_attributes][NEW_RECORD][order_item_attributes][quantity]" />
    </div>
    <div class="col-md-2">
      <input class="form-control" placeholder="A entregar" type="number" min="1" value="1" name="delivery[delivery_items_attributes][NEW_RECORD][quantity_delivered]" />
    </div>
    <div class="col-md-3">
      <textarea class="form-control" placeholder="Notas" name="delivery[delivery_items_attributes][NEW_RECORD][order_item_attributes][notes]" rows="1"></textarea>
    </div>
    <div class="col-md-1 d-flex align-items-center">
      <a href="#" class="btn btn-outline-danger btn-sm" data-action="click->delivery-form#removeDeliveryItem">×</a>
      <input type="hidden" name="delivery[delivery_items_attributes][NEW_RECORD][_destroy]" class="destroy-flag" />
    </div>
  </div>
  <div class="row">
    <div class="col-12">
      <%= link_to "Agregar producto", "#", class: "btn btn-outline-secondary btn-sm", 
          data: { action: "click->delivery-form#addDeliveryItem" } %>
    </div>
  </div>
</div>