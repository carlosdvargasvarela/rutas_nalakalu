<div class="card shadow-sm mb-4" data-delivery-form-target="addressCard">
  <div class="card-header bg-success text-white d-flex align-items-center">
    <i class="bi bi-geo-alt-fill me-2"></i>
    <h5 class="mb-0">Direcci贸n de entrega</h5>
  </div>
  <div class="card-body">
    <!-- Tabs para direcci贸n existente o nueva -->
    <ul class="nav nav-tabs mb-3" id="addressTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link <%= 'active' unless params[:delivery_address].present? %>"
                id="existing-tab"
                data-bs-toggle="tab"
                data-bs-target="#existing-address"
                type="button"
                role="tab"
                aria-controls="existing-address"
                aria-selected="<%= params[:delivery_address].blank? %>">
          <i class="bi bi-bookmark-fill me-1"></i> Direcciones guardadas
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link <%= 'active' if params[:delivery_address].present? %>"
                id="new-tab"
                data-bs-toggle="tab"
                data-bs-target="#new-address"
                type="button"
                role="tab"
                aria-controls="new-address"
                aria-selected="<%= params[:delivery_address].present? %>">
          <i class="bi bi-plus-circle me-1"></i> Buscar/Crear nueva
        </button>
      </li>
    </ul>
    <div class="tab-content" id="addressTabContent">
      <!-- Tab: Direcciones guardadas -->
      <div class="tab-pane fade <%= 'show active' unless params[:delivery_address].present? %>"
           id="existing-address"
           role="tabpanel"
           aria-labelledby="existing-tab">
        <div class="mb-3">
          <label for="delivery_delivery_address_id" class="form-label fw-bold">
            <i class="bi bi-bookmark me-1"></i> Seleccionar direcci贸n guardada
          </label>
          <%= f.select :delivery_address_id,
                options_from_collection_for_select(
                  addresses || [],
                  :id,
                  :address,
                  f.object.delivery_address_id || f.object.delivery_address&.id
                ),
                { prompt: "Selecciona una direcci贸n" },
                class: "form-select form-select-lg",
                data: {
                  controller: "tom-select",
                  "delivery-form-target": "addressSelect",
                  "address-selector-target": "select",
                  action: "change->delivery-form#addressChanged " \
                          "change->delivery-form#validateAddress " \
                          "change->address-selector#updateMap"
                } %>
          <div class="form-text">
            <i class="bi bi-info-circle me-1"></i>
            Selecciona una direcci贸n previamente guardada para este cliente.
          </div>
        </div>
        <div id="existing-address-preview"
             data-delivery-form-target="existingAddressPreview"
             style="display: none;">
          <div class="alert alert-info">
            <h6 class="alert-heading">
              <i class="bi bi-geo-alt me-1"></i> Direcci贸n seleccionada:
            </h6>
            <p class="mb-1" data-delivery-form-target="existingAddressText"></p>
            <small class="text-muted" data-delivery-form-target="existingAddressCoords"></small>
          </div>
        </div>
      </div>
      <!-- Tab: Buscar/Crear nueva direcci贸n -->
      <!--  AQU VA EL data-controller="address-autocomplete" ENVOLVIENDO TODOS LOS TARGETS -->
      <div class="tab-pane fade <%= 'show active' if params[:delivery_address].present? %>"
           id="new-address"
           role="tabpanel"
           aria-labelledby="new-tab"
           data-controller="address-autocomplete"
           data-address-autocomplete-api-key-value="<%= ENV.fetch('GOOGLE_MAPS_API_KEY', '') %>">
        <div class="alert alert-warning d-flex align-items-center mb-3" role="alert">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          <div>
            <strong>Importante:</strong> Usa el buscador o el mapa para obtener coordenadas precisas.
          </div>
        </div>
        <!-- Buscador de direcciones con autocompletado -->
        <div class="mb-3">
          <label for="delivery_address_address" class="form-label fw-bold">
            <i class="bi bi-search me-1"></i> Buscar direcci贸n *
          </label>
          <%= text_field_tag "delivery_address[address]",
                params.dig(:delivery_address, :address),
                placeholder: "Ej: 200 metros norte de la Iglesia, casa blanca con port贸n negro",
                class: "form-control form-control-lg",
                data: {
                  "address-autocomplete-target": "input",
                  "delivery-form-target": "newAddressInput",
                  "address-validator-target": "addressInput",
                  action: "input->delivery-form#validateAddress input->address-validator#validateAddress"
                } %>
          <div class="form-text">
            <i class="bi bi-info-circle me-1"></i>
            Escribe la direcci贸n completa. El sistema intentar谩 geocodificarla autom谩ticamente.
          </div>
        </div>
        <!-- Info direcci贸n seleccionada (autocomplete) -->
        <div data-address-autocomplete-target="selectedAddressInfo"
             class="alert alert-info mb-3"
             style="display:none;">
          <div class="d-flex align-items-center">
            <i class="bi bi-info-circle me-2"></i>
            <div>
              <strong>Direcci贸n seleccionada:</strong><br>
              <span data-address-autocomplete-target="selectedAddressText"></span>
            </div>
          </div>
        </div>
        <!-- Mapa peque帽o para preview del autocomplete -->
        <div data-address-autocomplete-target="map"
             style="height: 250px;"
             class="mb-3 border rounded">
        </div>
        <!-- Coordenadas (readonly, se llenan autom谩ticamente) -->
        <div class="row mb-3">
          <div class="col-md-4">
            <label for="delivery_address_latitude" class="form-label fw-bold">
              <i class="bi bi-geo me-1"></i> Latitud
            </label>
            <%= number_field_tag "delivery_address[latitude]",
                  params.dig(:delivery_address, :latitude),
                  step: "any",
                  class: "form-control form-control-sm",
                  placeholder: "9.9281",
                  data: {
                    "address-autocomplete-target": "lat",
                    "delivery-form-target": "newAddressLat",
                    action: "change->address-autocomplete#updateMapFromCoordinates"
                  } %>
          </div>
          <div class="col-md-4">
            <label for="delivery_address_longitude" class="form-label fw-bold">
              <i class="bi bi-geo me-1"></i> Longitud
            </label>
            <%= number_field_tag "delivery_address[longitude]",
                  params.dig(:delivery_address, :longitude),
                  step: "any",
                  class: "form-control form-control-sm",
                  placeholder: "-84.0907",
                  data: {
                    "address-autocomplete-target": "lng",
                    "delivery-form-target": "newAddressLng",
                    action: "change->address-autocomplete#updateMapFromCoordinates"
                  } %>
          </div>
          <div class="col-md-4">
            <label for="delivery_address_plus_code" class="form-label fw-bold">
              <i class="bi bi-pin-map me-1"></i> Plus Code
            </label>
            <%= text_field_tag "delivery_address[plus_code]",
                  params.dig(:delivery_address, :plus_code),
                  class: "form-control form-control-sm",
                  placeholder: "W2H5+2Q San Jos茅",
                  readonly: true,
                  data: {
                    "address-autocomplete-target": "plus",
                    "delivery-form-target": "newAddressPlusCode"
                  } %>
          </div>
        </div>
        <div class="form-text mb-3">
          <i class="bi bi-info-circle me-1"></i>
          Las coordenadas se obtienen autom谩ticamente al buscar la direcci贸n o hacer clic en el mapa.
        </div>
        <!-- Hidden field para client_id -->
        <%= hidden_field_tag "delivery_address[client_id]",
            (@client&.id || delivery.order&.client&.id),
            data: { "delivery-form-target": "newAddressClientId" } %>
      </div>
      <!-- FIN del tab "Buscar/Crear nueva" y del controller address-autocomplete -->
    </div>
    <!--  Descripci贸n adicional (siempre visible) -->
    <div class="mt-4 p-3 border rounded bg-light">
      <label for="delivery_address_description" class="form-label fw-bold text-danger">
        <i class="bi bi-card-text me-1"></i> Referencia exacta de entrega *
      </label>
      <%= text_field_tag "delivery_address[description]",
        params.dig(:delivery_address, :description),
        placeholder: "Ej: Casa blanca, port贸n negro, 200m norte de la iglesia, frente al supermercado",
        class: "form-control form-control-lg",
        data: {
          "delivery-form-target": "newAddressDescription",
          "address-validator-target": "addressInput",
          action: "input->address-validator#validateAddress"
        } %>
      <div class="form-text">
        <i class="bi bi-info-circle me-1"></i>
        Esta informaci贸n es <strong>clave</strong> para el chofer. S茅 lo m谩s espec铆fico posible.
      </div>
    </div>
    <!-- Mapa de preview (se muestra siempre, fuera de los tabs) -->
    <div class="mt-4">
      <h6 class="fw-bold mb-2">
        <i class="bi bi-map me-1"></i> Vista previa en mapa
      </h6>
      <div id="address-map"
           style="height: 400px; width: 100%; border-radius: 8px; border: 2px solid #dee2e6;"
           data-controller="address-map"
           data-address-map-latitude-value="<%= params.dig(:delivery_address, :latitude) || delivery.delivery_address&.latitude || 9.9281 %>"
           data-address-map-longitude-value="<%= params.dig(:delivery_address, :longitude) || delivery.delivery_address&.longitude || -84.0907 %>"
           data-address-selector-target="map">
      </div>
      <div class="form-text mt-2">
        <i class="bi bi-info-circle me-1"></i>
        Haz clic en el mapa para ajustar la ubicaci贸n exacta de la entrega.
      </div>
    </div>
    <!-- Indicador de validaci贸n de direcci贸n -->
    <div class="mt-3"
         data-delivery-form-target="addressValidation"
         style="display: none;">
      <div class="alert alert-danger d-flex align-items-center mb-0" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <div data-delivery-form-target="addressValidationMessage"></div>
      </div>
    </div>
  </div>
</div>