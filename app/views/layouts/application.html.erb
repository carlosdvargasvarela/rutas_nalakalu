<!-- app/views/layouts/application.html.erb -->
<!DOCTYPE html>
<html>
  <head>
    <title>NaLakalu - Rutas de Entrega</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload", media: "all" %>
    <%= javascript_importmap_tags %>
    <%= javascript_include_tag "chartkick", "Chart.bundle" %>
    <!-- Bootstrap Icons CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  </head>
  <body data-controller="bootstrap-tooltip">
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.min.js" integrity="sha384-7qAoOXltbVP82dhxHAUje59V5r2YsVfBafyUDxEdApLPmcdhBPg1DKg1ERo0BZlK" crossorigin="anonymous"></script>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
      <div class="container-fluid">
        <%= link_to root_path, class: "navbar-brand d-flex align-items-center gap-2" do %>
          <i class="bi bi-truck fs-3"></i>
          <span>NaLakalu</span>
        <% end %>
        <% if user_signed_in? %>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar" aria-controls="mainNavbar" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="mainNavbar">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
              <li class="nav-item">
                <%= link_to root_path, class: "nav-link #{'active' if current_page?(root_path)}" do %>
                  <i class="bi bi-speedometer2 me-1"></i> Dashboard
                <% end %>
              </li>
              <li class="nav-item">
                <%= link_to orders_path, class: "nav-link #{'active' if current_page?(orders_path)}" do %>
                  <i class="bi bi-box-seam me-1"></i> Pedidos
                <% end %>
              </li>
              <li class="nav-item">
                <%= link_to deliveries_path, class: "nav-link #{'active' if current_page?(deliveries_path)}" do %>
                  <i class="bi bi-truck me-1"></i> Entregas
                <% end %>
              </li>
              <li class="nav-item">
                <%= link_to delivery_plans_path, class: "nav-link #{'active' if current_page?(delivery_plans_path)}" do %>
                  <i class="bi bi-calendar-check me-1"></i> Planes de Entrega
                <% end %>
              </li>
              <li class="nav-item">
                <%= link_to new_delivery_import_path, class: "nav-link #{'active' if current_page?(new_delivery_import_path)}" do %>
                  <i class="bi bi-file-earmark-arrow-up me-1"></i> Importar Excel
                <% end %>
              </li>
              <li><span class="nav-link disabled px-2">|</span></li>
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" id="catalogosDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="bi bi-collection me-1"></i> Catálogos
                </a>
                <ul class="dropdown-menu" aria-labelledby="catalogosDropdown">
                  <li>
                    <%= link_to clients_path, class: "dropdown-item" do %>
                      <i class="bi bi-people me-1"></i> Clientes
                    <% end %>
                  </li>
                  <li>
                    <%= link_to sellers_path, class: "dropdown-item" do %>
                      <i class="bi bi-person-badge me-1"></i> Vendedores
                    <% end %>
                  </li>
                  <li><hr class="dropdown-divider"></li>
                  <li>
                    <%= link_to service_cases_deliveries_path, class: "dropdown-item" do %>
                      <i class="bi bi-tools me-1"></i> Casos de Servicio
                    <% end %>
                  </li>
                </ul>
              </li>
            </ul>
            <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
              <li class="nav-item d-flex align-items-center">
                <span class="navbar-text me-2 d-none d-lg-inline">
                  <i class="bi bi-person-circle me-1"></i>
                  <%= current_user.name %> (<%= current_user.display_role %>)
                </span>
                <%= link_to "Cerrar Sesión", destroy_user_session_path, method: :delete, class: "btn btn-outline-light btn-sm ms-2" %>
              </li>
              <li class="nav-item dropdown">
                <a class="nav-link position-relative" href="#" id="notificationsDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="bi bi-bell"></i>
                  <% unread_count = current_user.unread_notifications_count %>
                  <% if unread_count > 0 %>
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                      <%= unread_count %>
                    </span>
                  <% end %>
                </a>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="notificationsDropdown" style="min-width: 350px;">
                  <% current_user.notifications.recent.limit(10).each do |notification| %>
                    <li class="<%= 'bg-light' unless notification.read %>">
                      <a class="dropdown-item d-flex justify-content-between align-items-center" href="<%= polymorphic_url(notification.notifiable) rescue '#' %>">
                        <span>
                          <%= notification.message %>
                          <br>
                          <small class="text-muted"><%= l(notification.created_at, format: :short) %></small>
                        </span>
                        <% unless notification.read %>
                          <span class="badge bg-primary ms-2">Nuevo</span>
                        <% end %>
                      </a>
                    </li>
                  <% end %>
                  <li>
                    <hr class="dropdown-divider">
                  </li>
                  <li>
                    <%= link_to "Ver todas las notificaciones", notifications_path, class: "dropdown-item text-center" %>
                  </li>
                </ul>
              </li>
            </ul>
          </div>
        <% end %>
      </div>
    </nav>
    <main class="container-fluid mt-4">
      <% if notice %>
        <div class="alert alert-success alert-dismissible fade show">
          <%= notice %>
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      <% end %>
      <% if alert %>
        <div class="alert alert-danger alert-dismissible fade show">
          <%= alert %>
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      <% end %>
      <%= yield %>
    </main>
  </body>
</html>