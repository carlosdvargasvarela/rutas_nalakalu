<%# app/views/admin/users/_form.html.erb %>
<%= simple_form_for([:admin, @user]) do |f| %>
  <div class="row justify-content-center">
    <div class="col-12 col-md-10 col-lg-8">
      <%= f.input :name,
                  label: "Nombre",
                  input_html: { class: "form-control form-control-lg rounded-3 border-2 shadow-sm devise-sessions-input" },
                  label_html: { class: "fw-semibold text-dark mb-2", style: "font-family: 'Inter', 'Matter', sans-serif; font-weight: 500;" } %>
      <%= f.input :email,
                  label: "Correo electrónico",
                  input_html: { class: "form-control form-control-lg rounded-3 border-2 shadow-sm devise-sessions-input" },
                  label_html: { class: "fw-semibold text-dark mb-2", style: "font-family: 'Inter', 'Matter', sans-serif; font-weight: 500;" } %>
      <%= f.input :role,
                  label: "Rol",
                  collection: User.roles.keys.map { |r| [r.humanize, r] },
                  include_blank: false,
                  input_html: { class: "form-select form-select-lg rounded-3 border-2 shadow-sm devise-sessions-input" },
                  label_html: { class: "fw-semibold text-dark mb-2", style: "font-family: 'Inter', 'Matter', sans-serif; font-weight: 500;" } %>
      <div class="mb-3">
        <%= f.input :send_notifications,
                    as: :boolean,
                    label: "Recibir notificaciones",
                    wrapper_html: { class: "form-check form-switch mb-0" },
                    input_html: { class: "form-check-input" },
                    label_html: { class: "form-check-label ms-2", style: "font-family: 'Space Mono', monospace !important; font-weight: 400 !important; color: #6c757d;" } %>
      </div>
      <%# En edit: permitir cambio de contraseña; en new puedes mantener visible (tu controller le pone una por defecto igualmente) %>
      <%= f.input :password,
                  label: "Contraseña",
                  hint: (@user.persisted? ? "Déjalo en blanco para no cambiarla" : "Opcional, se enviará correo de acceso"),
                  required: false,
                  input_html: { class: "form-control form-control-lg rounded-3 border-2 shadow-sm devise-sessions-input" },
                  label_html: { class: "fw-semibold text-dark mb-2", style: "font-family: 'Inter', 'Matter', sans-serif; font-weight: 500;" },
                  hint_html: { style: "font-family: 'Space Mono', monospace !important; font-size: 0.875rem !important; font-weight: 400 !important;" } %>
      <%= f.input :password_confirmation,
                  label: "Confirmar contraseña",
                  required: false,
                  input_html: { class: "form-control form-control-lg rounded-3 border-2 shadow-sm devise-sessions-input" },
                  label_html: { class: "fw-semibold text-dark mb-2", style: "font-family: 'Inter', 'Matter', sans-serif; font-weight: 500;" } %>
      <%# Código de vendedor: visible si es seller o si el registro es nuevo (por si se selecciona seller en vivo) %>
      <% if @user.seller? || @user.new_record? || @user.role == "seller" %>
        <%= f.input :seller_code,
                    label: "Código de vendedor",
                    input_html: { value: @user.seller&.seller_code, class: "form-control form-control-lg rounded-3 border-2 shadow-sm devise-sessions-input" },
                    label_html: { class: "fw-semibold text-dark mb-2", style: "font-family: 'Inter', 'Matter', sans-serif; font-weight: 500;" } %>
      <% end %>
    </div>
  </div>
  <%# Tripulación solo visible para rol driver (toggle live con Stimulus) %>
  <div id="driver-crew-section" data-controller="show-hide" data-show-hide-role-value="driver">
    <div class="row justify-content-center">
      <div class="col-12 col-md-10 col-lg-8">
    <h4 class="mt-3 fw-semibold text-dark">
      <i class="bi bi-people-fill me-1"></i>
      Tripulación del camión
    </h4>
    <div data-controller="nested-form">
      <div id="crew-members-list">
        <%= f.simple_fields_for :crew_members do |cmf| %>
          <div class="card mb-2 p-3 border-0 shadow-sm rounded-3" data-nested-form-target="item">
            <div class="row">
              <div class="col-md-5"><%= cmf.input :name, label: "Nombre", input_html: { class: "form-control form-control-lg rounded-3 border-2 shadow-sm" }, label_html: { class: "fw-semibold text-dark mb-2" } %></div>
              <div class="col-md-5"><%= cmf.input :id_number, label: "Cédula", input_html: { class: "form-control form-control-lg rounded-3 border-2 shadow-sm" }, label_html: { class: "fw-semibold text-dark mb-2" } %></div>
              <div class="col-md-2 d-flex align-items-end justify-content-end">
                <% if cmf.object.persisted? %>
                  <%= cmf.input :_destroy, as: :boolean, label: "Eliminar", wrapper_html: { class: "form-check" }, input_html: { class: "form-check-input" }, label_html: { class: "form-check-label" } %>
                <% else %>
                  <button class="btn btn-outline-danger rounded-3" data-action="click->nested-form#remove" type="button" title="Quitar">
                    <i class="bi bi-x-circle"></i>
                  </button>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
      <%= link_to "#", class: "btn btn-outline-dark rounded-3", data: { action: "click->nested-form#add" } do %>
        <i class="bi bi-person-plus me-1"></i>
        Agregar persona
      <% end %>
      <template data-nested-form-target="template">
        <div class="card mb-2 p-3 border-0 shadow-sm rounded-3" data-nested-form-target="item">
          <div class="row">
            <div class="col-md-5">
              <input type="text" name="user[crew_members_attributes][NEW_RECORD][name]" class="form-control form-control-lg rounded-3 border-2 shadow-sm" placeholder="Nombre" />
            </div>
            <div class="col-md-5">
              <input type="text" name="user[crew_members_attributes][NEW_RECORD][id_number]" class="form-control form-control-lg rounded-3 border-2 shadow-sm" placeholder="Cédula" />
            </div>
            <div class="col-md-2 d-flex align-items-end justify-content-end">
              <button class="btn btn-outline-danger rounded-3" data-action="click->nested-form#remove" type="button" title="Quitar">
                <i class="bi bi-x-circle"></i>
              </button>
              <input type="hidden" name="user[crew_members_attributes][NEW_RECORD][_destroy]" value="false" />
            </div>
          </div>
        </div>
      </template>
    </div>
      </div>
    </div>
  </div>
  <div class="mt-3 d-flex justify-content-center gap-2">
    <%= f.button :submit, class: "btn btn-dark rounded-3 dashboard-action-btn" %>
    <%= link_to "Cancelar", admin_users_path, class: "btn btn-outline-dark rounded-3 dashboard-action-btn" %>
  </div>
<% end %>