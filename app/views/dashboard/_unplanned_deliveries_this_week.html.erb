<!-- app/views/dashboard/_unplanned_deliveries_this_week.html.erb -->
<div class="card unplanned-deliveries-card border-0 rounded-3 mt-5">
  <div class="card-header bg-light d-flex align-items-center justify-content-between">
    <h5 class="mb-0 fw-semibold">
      <i class="bi bi-list-ul me-2 text-primary"></i>
      Entregas de esta semana sin plan
    </h5>
    <span class="badge bg-primary text-white px-3 py-2 delivery-count-badge">
      <%= deliveries.respond_to?(:total_count) ? deliveries.total_count : deliveries.size %> entregas
    </span>
  </div>
  <% if deliveries.any? %>
    <div class="list-group list-group-flush">
      <% deliveries.each do |delivery| %>
        <div class="list-group-item delivery-item-animated">
          <div class="d-flex flex-column flex-md-row align-items-start justify-content-between gap-3">
            <div class="d-flex flex-column flex-sm-row align-items-start gap-3 flex-grow-1 w-100">
              <div class="delivery-date-badge text-center" style="min-width: 110px;">
                <div class="fw-bold"><%= l delivery.delivery_date, format: :short %></div>
                <%# Color según tipo con estilos inline para mejor contraste %>
                <% if delivery.normal?
                     badge_style = 'background-color: #198754; color: white;' # Verde oscuro
                   elsif delivery.internal_delivery?
                     badge_style = 'background-color: #ffc107; color: #000;' # Amarillo con texto negro
                   elsif delivery.only_pickup?
                     badge_style = 'background-color: #0dcaf0; color: #000;' # Cyan con texto negro
                   else
                     badge_style = 'background-color: #212529; color: white;' # Negro
                   end %>
                <div class="mt-1">
                  <span class="badge delivery-type-badge" style="<%= badge_style %>">
                    <%= delivery.display_type %>
                  </span>
                </div>
                <%# Badge de estado con estilos inline %>
                <% status_style = case delivery.status
                     when 'scheduled' then 'background-color: #6c757d; color: white;' # Gris oscuro
                     when 'ready_to_deliver' then 'background-color: #198754; color: white;' # Verde oscuro
                     when 'in_plan' then 'background-color: #0d6efd; color: white;' # Azul oscuro
                     when 'in_route' then 'background-color: #0dcaf0; color: #000;' # Cyan con negro
                     when 'delivered' then 'background-color: #198754; color: white;' # Verde oscuro
                     when 'rescheduled' then 'background-color: #fd7e14; color: white;' # Naranja oscuro
                     when 'cancelled' then 'background-color: #dc3545; color: white;' # Rojo
                     when 'failed' then 'background-color: #dc3545; color: white;' # Rojo
                     else 'background-color: #6c757d; color: white;' # Gris oscuro
                     end %>
                <div class="mt-1">
                  <span class="badge delivery-status-badge" style="<%= status_style %>">
                    <%= delivery.display_status %>
                  </span>
                </div>
              </div>
              <div class="flex-grow-1 delivery-info">
                <div class="fw-semibold delivery-title">
                  Pedido <%= link_to delivery.order.number, delivery_path(delivery), class: "text-decoration-none" %>
                  — <%= delivery.order.client.name %>
                </div>
                <div class="text-muted small">
                  <i class="bi bi-geo-alt me-1"></i>
                  <%= truncate(delivery.delivery_address.address.to_s, length: 80) %>
                </div>
                <div class="text-muted small">
                  <i class="bi bi-person-badge me-1"></i>
                  Vendedor: <%= delivery.order.seller.name %>
                </div>
                <% if delivery.delivery_time_preference.present? %>
                  <div class="text-muted small">
                    <i class="bi bi-clock me-1"></i>
                    Preferencia: <%= delivery.delivery_time_preference %>
                  </div>
                <% end %>
              </div>
            </div>
            <div class="text-end text-sm-start text-md-end delivery-actions w-100 w-md-auto">
              <div class="btn-group delivery-btn-group flex-wrap">
                <%= link_to delivery_path(delivery),
                            class: "btn btn-outline-primary btn-sm rounded-pill" do %>
                  <i class="bi bi-eye"></i> Ver
                <% end %>
                <% if current_user.admin? || current_user.production_manager? || current_user.logistics? %>
                  <%= link_to delivery_plans_path(q: { week_eq: Date.current.cweek, year_eq: Date.current.cwyear }),
                              class: "btn btn-outline-success btn-sm rounded-pill",
                              title: "Ir a planes de esta semana" do %>
                    <i class="bi bi-diagram-3"></i> Planes
                  <% end %>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    </div>
    <%# Paginación opcional si activas kaminari en el controlador %>
    <% if deliveries.respond_to?(:current_page) %>
      <div class="card-footer d-flex justify-content-center">
        <%= paginate deliveries, param_name: "page_unplanned" %>
      </div>
    <% end %>
  <% else %>
    <div class="p-4 text-center text-muted empty-state">
      <i class="bi bi-inbox fs-3 d-block mb-2 empty-icon"></i>
      No hay entregas sin plan para esta semana
    </div>
  <% end %>
</div>