<div class="card shadow-sm mb-4 d-block d-md-none">
  <div class="card-header bg-light fw-bold">
    <i class="bi bi-truck-flatbed me-1"></i> Entregas de este plan
  </div>
  <div class="card-body">
    <% if delivery_plan.delivery_plan_assignments.any? %>
      <div class="row g-2">
        <% delivery_plan.delivery_plan_assignments.order(:stop_order).each do |assignment| %>
          <% delivery = assignment.delivery %>
          <div class="col-12">
            <div class="card shadow-sm">
              <div class="card-body p-3">
                <h6 class="fw-bold mb-2">
                  <span class="badge bg-primary">#<%= assignment.stop_order %></span>
                  Pedido: <%= delivery.order.number %>
                </h6>
                <p><i class="bi bi-person me-1"></i><%= delivery.order.client.name %></p>
                <p>
                  <% if delivery.delivery_address.latitude.present? && delivery.delivery_address.longitude.present? %>
                    <%= link_to [delivery.delivery_address.address, delivery.delivery_address.description].compact.join(" - "),
                                "https://waze.com/ul?ll=#{delivery.delivery_address.latitude},#{delivery.delivery_address.longitude}&navigate=yes",
                                target: "_blank", rel: "noopener", class: "text-decoration-none fw-bold text-primary" %>
                  <% else %>
                    <%= link_to [delivery.delivery_address.address, delivery.delivery_address.description].compact.join(" - "),
                                "https://waze.com/ul?q=#{ERB::Util.url_encode(delivery.delivery_address.address)}&navigate=yes",
                                target: "_blank", rel: "noopener", class: "text-decoration-none fw-bold text-primary" %>
                  <% end %>
                </p>
                <p><i class="bi bi-calendar-event me-1"></i><%= l delivery.delivery_date, format: :short %></p>
                <p><i class="bi bi-telephone me-1"></i><%= delivery.contact_name %>
                  <%= link_to delivery.contact_phone, "tel:#{delivery.contact_phone}" if delivery.contact_phone.present? %>
                </p>
                <span class="badge bg-<%= delivery_status_color(delivery.status) %>"><%= delivery.display_status %></span>
                <% if delivery.delivery_items.any? %>
                  <div class="mt-2 d-flex gap-1">
                    <button class="btn btn-sm btn-outline-info flex-fill"
                        data-bs-toggle="collapse"
                        data-bs-target="#productosMovil<%= delivery.id %>">
                      <i class="bi bi-box-seam"></i> Ver productos
                    </button>
                    <button class="btn btn-sm btn-outline-primary"
                        data-bs-toggle="modal"
                        data-bs-target="#notaEntregaModal<%= delivery.id %>">
                      <i class="bi bi-sticky"></i> Agregar nota
                    </button>
                  </div>
                  <div class="collapse mt-2" id="productosMovil<%= delivery.id %>">
                    <ul class="small ps-3 mb-0">
                      <% delivery.active_items_for_plan.each do |item| %>
                        <li>
                          <strong><%= item.order_item.product %></strong>
                          <span class="badge bg-secondary ms-1"><%= item.quantity_delivered %></span>
                          <% if item.notes.present? %>
                            <br>
                            <span class="text-primary"><i class="bi bi-pin-angle-fill"></i> <em><%= item.notes %></em></span>
                          <% end %>
                          <% if item.order_item.notes.present? %>
                            <br>
                            <span class="text-muted"><i class="bi bi-info-circle"></i> <%= item.order_item.notes %></span>
                          <% end %>
                        </li>
                      <% end %>
                    </ul>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <div class="alert alert-info">No hay entregas asignadas.</div>
    <% end %>
  </div>
</div>