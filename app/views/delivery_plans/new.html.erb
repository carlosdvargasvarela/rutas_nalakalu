<!-- app/views/delivery_plans/new.html.erb -->
<% if @delivery_plan.errors.any? %>
  <div class="alert alert-danger mb-4">
    <h6><i class="bi bi-exclamation-triangle me-2"></i> Se encontraron errores:</h6>
    <ul class="mb-0">
      <% @delivery_plan.errors.full_messages.each do |message| %>
        <li><%= message %></li>
      <% end %>
    </ul>
  </div>
<% end %>
<div data-controller="delivery-plan-table">
  <h1 class="mb-4">
    <i class="bi bi-map me-2"></i>
    Crear Plan de Ruta
  </h1>
  <%# Mostrar el rango de la semana seleccionada %>
  <% if @from && @to %>
    <div class="alert alert-secondary mb-4">
      <i class="bi bi-calendar-range me-2"></i>
      <strong>Plazo seleccionado:</strong>
      <span class="text-muted">del <%= l @from, format: :long %> al <%= l @to, format: :long %></span>
    </div>
  <% end %>
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <%= search_form_for @q, url: new_delivery_plan_path, method: :get, html: { class: "mb-0" } do |f| %>
        <div class="row g-2 align-items-end">
          <div class="col-md-2">
            <%= f.label :delivery_date_gteq, "Desde", class: "form-label" %>
            <%= f.date_field :delivery_date_gteq, value: @from, class: "form-control" %>
          </div>
          <div class="col-md-2">
            <%= f.label :delivery_date_lteq, "Hasta", class: "form-label" %>
            <%= f.date_field :delivery_date_lteq, value: @to, class: "form-control" %>
          </div>
          <div class="col-md-2">
            <%= f.label :order_number_cont, "Pedido", class: "form-label" %>
            <%= f.search_field :order_number_cont, class: "form-control" %>
          </div>
          <div class="col-md-2">
            <%= f.label :order_client_name_cont, "Cliente", class: "form-label" %>
            <%= f.search_field :order_client_name_cont, class: "form-control" %>
          </div>
          <div class="col-md-2">
            <%= f.label :delivery_address_address_cont, "Dirección", class: "form-label" %>
            <%= f.search_field :delivery_address_address_cont, class: "form-control" %>
          </div>
          <div class="col-md-2 d-grid">
            <%= f.submit "Buscar", class: "btn btn-outline-primary" %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
  <h5 class="mb-3">
    <i class="bi bi-truck-flatbed me-1"></i>
    Entregas disponibles
    <% if @from == @to %>
      para <%= l @from, format: :long %>
    <% else %>
      del <%= l @from, format: :long %> al <%= l @to, format: :long %>
    <% end %>:
  </h5>
  <% if @deliveries.any? %>
    <div class="card shadow-sm">
      <div class="card-body">
        <%= simple_form_for @delivery_plan, url: delivery_plans_path, method: :post, html: { class: "mb-0" } do |f| %>
          <%= f.input :week, as: :hidden, input_html: { value: @from.cweek } %>
          <%= f.input :year, as: :hidden, input_html: { value: @from.year } %>
          <%= f.input :status, as: :hidden, input_html: { value: "draft" } %>
          <% if params[:q].present? %>
            <% params[:q].each do |key, value| %>
              <%= hidden_field_tag "q[#{key}]", value %>
            <% end %>
          <% end %>
          <div class="table-responsive">
            <table class="table table-sm table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th>
                    <input type="checkbox" id="select-all" class="form-check-input" title="Seleccionar todas">
                  </th>
                  <th>Pedido</th>
                  <th>Cliente</th>
                  <th>Dirección</th>
                  <th>Fecha</th>
                  <th>Productos</th>
                </tr>
              </thead>
              <tbody>
                <% @deliveries.each do |delivery| %>
                  <tr>
                    <td>
                      <%= check_box_tag "delivery_ids[]", delivery.id, @selected_delivery_ids&.include?(delivery.id), class: "form-check-input delivery-checkbox" %>
                    </td>
                    <td>
                      <%= link_to delivery.order.number, order_path(delivery.order), class: "text-decoration-none fw-bold" %>
                    </td>
                    <td>
                      <i class="bi bi-person me-1"></i>
                      <%= delivery.order.client.name %>
                    </td>
                    <td>
                      <i class="bi bi-geo-alt me-1"></i>
                      <%= delivery.delivery_address.address %>
                    </td>
                    <td>
                      <span class="badge bg-info text-dark">
                        <i class="bi bi-calendar-event me-1"></i>
                        <%= l delivery.delivery_date, format: :short %>
                      </span>
                    </td>
                    <td>
                      <% if delivery.delivery_items.any? %>
                        <ul class="mb-0 ps-3 small">
                          <% delivery.delivery_items.each do |item| %>
                            <li>
                              <strong><%= item.order_item.product %></strong>
                              <span class="badge bg-secondary ms-1"><%= item.quantity_delivered %></span>
                              <% if item.order_item.notes.present? %>
                                <span class="text-muted ms-1" data-bs-toggle="tooltip" title="<%= item.order_item.notes %>">
                                  <i class="bi bi-info-circle"></i>
                                </span>
                              <% end %>
                            </li>
                          <% end %>
                        </ul>
                      <% else %>
                        <span class="text-muted">Sin productos</span>
                      <% end %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
          <div class="d-flex justify-content-end mt-3">
            <%= f.button :submit, "Crear Plan de Ruta", class: "btn btn-primary" %>
          </div>
        <% end %>
      </div>
    </div>
  <% else %>
    <div class="alert alert-info">
      <i class="bi bi-info-circle me-2"></i>
      No hay entregas disponibles para este rango de fechas.
    </div>
  <% end %>
</div>