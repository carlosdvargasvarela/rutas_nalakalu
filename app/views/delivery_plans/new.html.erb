<h1>Crear Plan de Ruta</h1>

<!-- Formulario de búsqueda (separado) -->
<%= search_form_for @q, url: new_delivery_plan_path, method: :get, html: { class: "mb-3" } do |f| %>
    <div class="row g-2">
        <div class="col">
        <%= f.label :delivery_date_gteq, "Desde" %>
        <%= f.date_field :delivery_date_gteq, value: @from, class: "form-control" %>
        </div>
        <div class="col">
        <%= f.label :delivery_date_lteq, "Hasta" %>
        <%= f.date_field :delivery_date_lteq, value: @to, class: "form-control" %>
        </div>
        <div class="col">
        <%= f.label :order_number_cont, "Pedido" %>
        <%= f.search_field :order_number_cont, class: "form-control" %>
        </div>
        <div class="col">
        <%= f.label :order_client_name_cont, "Cliente" %>
        <%= f.search_field :order_client_name_cont, class: "form-control" %>
        </div>
        <div class="col">
        <%= f.label :delivery_address_address_cont, "Dirección" %>
        <%= f.search_field :delivery_address_address_cont, class: "form-control" %>
        </div>
        <div class="col-auto align-self-end">
        <%= f.submit "Buscar", class: "btn btn-outline-primary" %>
        </div>
    </div>
<% end %>

<h5>
    Entregas disponibles
    <% if @from == @to %>
        para <%= l @from, format: :long %>
    <% else %>
        del <%= l @from, format: :long %> al <%= l @to, format: :long %>
    <% end %>:
</h5>

<!-- Formulario de creación del plan (separado) -->
<% if @deliveries.any? %>
    <%= form_with model: @delivery_plan, url: delivery_plans_path, local: true do |f| %>
        <%= f.hidden_field :week, value: @from.cweek %>
        <%= f.hidden_field :year, value: @from.year %>
        <%= f.hidden_field :status, value: DeliveryPlan.statuses[:draft] %>

        <table class="table table-sm">
        <thead>
            <tr>
            <th></th>
            <th>Pedido</th>
            <th>Cliente</th>
            <th>Dirección</th>
            <th>Fecha</th>
            </tr>
        </thead>
        <tbody>
            <% @deliveries.each do |delivery| %>
            <tr>
                <td><%= check_box_tag "delivery_ids[]", delivery.id %></td>
                <td><%= delivery.order.number %></td>
                <td><%= delivery.order.client.name %></td>
                <td><%= delivery.delivery_address.address %></td>
                <td><%= l delivery.delivery_date, format: :short %></td>
            </tr>
            <% end %>
        </tbody>
        </table>
        <%= f.submit "Crear Plan de Ruta", class: "btn btn-primary" %>
    <% end %>
<% else %>
    <p>No hay entregas disponibles para este rango de fechas.</p>
<% end %>