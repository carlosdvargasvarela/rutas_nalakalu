<div class="card shadow-sm mb-4">
  <div class="card-header bg-light fw-bold d-flex justify-content-between">
    <span><i class="bi bi-list-ol me-1"></i> Orden de paradas</span>
    <small class="text-muted"><i class="bi bi-arrows-move me-1"></i> Arrastra para reordenar</small>
  </div>
  <div class="table-responsive">
    <table class="table table-sm align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th style="width:40px;"></th>
          <th>#</th>
          <th>Cliente</th>
          <th>Dirección</th>
          <th>Hora pref.</th>
          <th style="width:220px;">Productos</th>
          <th style="width:280px;">Notas</th>
          <th style="width:70px;">Acción</th>
        </tr>
      </thead>
      <tbody data-controller="sortable"
             data-sortable-target="list"
             data-sortable-url-value="<%= update_order_delivery_plan_path(delivery_plan) %>">
        <% assignments.each_with_index do |assignment, idx| %>
          <% d = assignment.delivery %>
          <tr data-assignment-id="<%= assignment.id %>">
            <td class="text-center">
              <i class="bi bi-grip-vertical drag-handle text-muted"></i>
            </td>
            <td class="text-center">
              <span class="badge bg-primary stop-number"><%= assignment.stop_order || idx+1 %></span>
            </td>
            <td><%= d.order.client.name %></td>
            <td><%= [d.delivery_address.address, d.delivery_address.description].compact.join(" - ") %></td>
            <td><%= d.delivery_time_preference.presence || "--" %></td>

            <td>
              <a data-bs-toggle="collapse" href="#products_<%= assignment.id %>"
                 role="button" aria-expanded="false"
                 aria-controls="products_<%= assignment.id %>">
                <i class="bi bi-caret-down"></i> Ver productos
              </a>
              <div class="collapse mt-2" id="products_<%= assignment.id %>">
                <ul class="list-unstyled small mb-0">
                  <% d.delivery_items.includes(:order_item).each do |di| %>
                    <li class="mb-2">
                      • <strong><%= di.order_item.product %></strong>
                      <span class="badge bg-info"><%= di.quantity %> unidades</span>
                      <% if di.service_case %>
                        <span class="badge bg-warning text-dark">Caso de servicio</span>
                      <% end %>
                    </li>
                  <% end %>
                </ul>
              </div>
            </td>

            <!-- Nueva columna: Notas -->
            <td style="min-width: 280px;">
              <%# Nota de la entrega (si existe campo) %>
              <% if d.respond_to?(:delivery_notes) && d.delivery_notes.present? %>
                <div class="mb-2 p-2" style="background:#fff4e5; border-left:4px solid #fd7e14; border-radius:6px;">
                  <span class="fw-bold text-dark">
                    <i class="bi bi-sticky me-1 text-warning"></i> Nota de la entrega:
                  </span>
                  <div class="mt-1 text-dark"><em><%= d.delivery_notes %></em></div>
                </div>
              <% end %>

              <%# Notas de DeliveryItem %>
              <% d.delivery_items.each do |di| %>
                <% if di.notes.present? %>
                  <div class="mb-2 p-2" style="background:#fff4e5; border-left:4px solid #fd7e14; border-radius:6px;">
                    <span class="fw-bold text-dark">
                      <i class="bi bi-pin-angle-fill me-1 text-warning"></i> Nota de entrega:
                    </span>
                    <div class="mt-1 text-dark"><em><%= di.notes %></em></div>
                    <div class="small text-muted mt-1"><i class="bi bi-box-seam me-1"></i><%= di.order_item.product %></div>
                  </div>
                <% end %>
              <% end %>

              <%# Notas de OrderItem %>
              <% d.delivery_items.includes(:order_item).each do |di| %>
                <% if di.order_item.notes.present? %>
                  <div class="mb-2 p-2" style="background:#eef6ff; border-left:4px solid #0d6efd; border-radius:6px;">
                    <span class="fw-bold text-primary">
                      <i class="bi bi-info-circle me-1"></i> Nota del producto:
                    </span>
                    <div class="mt-1 text-dark"><%= di.order_item.notes %></div>
                    <div class="small text-muted mt-1"><i class="bi bi-box-seam me-1"></i><%= di.order_item.product %></div>
                  </div>
                <% end %>
              <% end %>
            </td>

            <td>
              <%= button_to delivery_plan_delivery_plan_assignment_path(delivery_plan, assignment),
                method: :delete,
                class: "btn btn-sm btn-outline-danger",
                form: { data: { turbo_confirm: "¿Eliminar esta parada?" },
                        class: "d-inline" } do %>
                <i class="bi bi-trash"></i>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>