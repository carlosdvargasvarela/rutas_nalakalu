<% if deliveries.any? %>
  <div class="card shadow-sm">
    <div class="card-header bg-light fw-semibold">
      <i class="bi bi-truck me-1"></i> Entregas disponibles
    </div>
    <div class="table-responsive">
      <table class="table table-hover table-sm align-middle">
        <thead class="table-primary">
          <tr>
            <th>
              <%= check_box_tag "select_all", "", false,
                    class: "form-check-input",
                    data: { action: "delivery-plan-sidebar#toggleAll" } %>
            </th>
            <th>Pedido</th>
            <th>Cliente</th>
            <th>Direcci√≥n</th>
            <th>Rango de horas</th>
            <th>Fecha</th>
            <th>Productos</th>
            <th>Notas</th>
          </tr>
        </thead>
        <tbody>
          <% deliveries.each do |delivery| %>
            <tr class="js-delivery-row" data-delivery-id="<%= delivery.id %>">
              <td>
                <%= check_box_tag "delivery_ids[]", delivery.id, selected_ids&.include?(delivery.id),
                            class: "form-check-input delivery-checkbox",
                            data: { action: "delivery-plan-sidebar#toggle",
                                    label: "#{delivery.order.number} - #{delivery.order.client.name}" } %>
              </td>
              <td class="fw-bold text-primary"><%= delivery.order.number %></td>
              <td><%= delivery.order.client.name %></td>
              <td><%= [delivery.delivery_address.address, delivery.delivery_address.description].compact.join(" - ") %></td>
              <td><%= delivery.delivery_time_preference || "Sin preferencia" %></td>
              <td><%= l delivery.delivery_date, format: :short %></td>
              <td>
                <% delivery.active_items_for_plan_for(current_user).each do |item| %>
                  <span class="badge bg-light text-dark me-1">
                    <%= item.order_item.product %> (<%= item.quantity_delivered %>)
                  </span>
                <% end %>
              </td>
              <td style="min-width: 300px;">
                <%# Nota de la entrega (si existe campo) %>
                <% if delivery.respond_to?(:delivery_notes) && delivery.delivery_notes.present? %>
                  <div class="mb-2 p-2" style="background:#fff4e5; border-left:4px solid #fd7e14; border-radius:6px;">
                    <span class="fw-bold text-dark">
                      <i class="bi bi-sticky me-1 text-warning"></i> Nota de la entrega:
                    </span>
                    <div class="mt-1 text-dark"><em><%= delivery.delivery_notes %></em></div>
                  </div>
                <% end %>

                <%# Notas de DeliveryItem %>
                <% delivery.active_items_for_plan_for(current_user).each do |item| %>
                  <% if item.notes.present? %>
                    <div class="mb-2 p-2" style="background:#fff4e5; border-left:4px solid #fd7e14; border-radius:6px;">
                      <span class="fw-bold text-dark">
                        <i class="bi bi-pin-angle-fill me-1 text-warning"></i> Nota de entrega:
                      </span>
                      <div class="mt-1 text-dark"><em><%= item.notes %></em></div>
                      <div class="small text-muted mt-1"><i class="bi bi-box-seam me-1"></i><%= item.order_item.product %></div>
                    </div>
                  <% end %>
                <% end %>

                <%# Notas de OrderItem %>
                <% delivery.active_items_for_plan_for(current_user).each do |item| %>
                  <% if item.order_item.notes.present? %>
                    <div class="mb-2 p-2" style="background:#eef6ff; border-left:4px solid #0d6efd; border-radius:6px;">
                      <span class="fw-bold text-primary">
                        <i class="bi bi-info-circle me-1"></i> Nota del producto:
                      </span>
                      <div class="mt-1 text-dark"><%= item.order_item.notes %></div>
                      <div class="small text-muted mt-1"><i class="bi bi-box-seam me-1"></i><%= item.order_item.product %></div>
                    </div>
                  <% end %>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
<% else %>
  <div class="alert alert-info">No hay entregas disponibles para este rango.</div>
<% end %>