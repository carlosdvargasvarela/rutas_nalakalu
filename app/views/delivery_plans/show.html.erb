<%# ================== ALERTA DE CONFIRMACIÓN ================== %>
<div class="alert <%= @delivery_plan.all_deliveries_confirmed? ? 'alert-success' : 'alert-warning' %> mt-3 d-flex align-items-center">
  <i class="bi <%= @delivery_plan.all_deliveries_confirmed? ? 'bi-check-circle-fill text-success' : 'bi-exclamation-triangle-fill text-warning' %> me-2 fs-5"></i>
  <div>
    <% if @delivery_plan.all_deliveries_confirmed? %>
      Todas las entregas de este plan han sido confirmadas ✔️
    <% else %>
      Existen entregas pendientes de confirmación ✋
    <% end %>
  </div>
</div>
<%# ================== ENCABEZADO ================== %>
<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
  <h1 class="mb-0">
    <i class="bi bi-map me-2 text-primary"></i>
    Plan de ruta: <%= week_range_label(@delivery_plan.year, @delivery_plan.week, show_year: true) %>
  </h1>
  <div class="d-flex gap-2 flex-wrap">
    <%= link_to delivery_plan_path(@delivery_plan, format: :xlsx), class: "btn btn-outline-success btn-sm" do %>
      <i class="bi bi-file-earmark-excel"></i> Exportar Excel
    <% end %>
    <%= link_to delivery_plan_path(@delivery_plan, format: :pdf),
            class: "btn btn-outline-danger btn-sm",
            download: "Hoja_Ruta_#{@from_date&.strftime('%d_%m_%Y')}_#{@delivery_plan.truck.presence || 'Sin_Camion'}.pdf" do %>
      <i class="bi bi-filetype-pdf"></i> Exportar PDF
    <% end %>
    <%= link_to edit_delivery_plan_path(@delivery_plan), class: "btn btn-outline-primary btn-sm" do %>
      <i class="bi bi-pencil"></i> Editar plan
    <% end %>
  </div>
</div>
<%# ================== INFO GENERAL ================== %>
<div class="row mb-4">
  <div class="col-lg-6">
    <div class="card shadow-sm">
      <div class="card-header bg-light fw-bold">
        <i class="bi bi-info-circle me-1"></i> Información General
      </div>
      <div class="card-body">
        <p><strong><i class="bi bi-calendar-week me-1"></i>Semana:</strong>
          <span class="badge bg-primary"><%= week_range_label(@delivery_plan.year, @delivery_plan.week) %></span></p>
        <p><strong><i class="bi bi-calendar me-1"></i>Año:</strong>
          <span class="badge bg-secondary"><%= @delivery_plan.year %></span></p>
        <p><strong><i class="bi bi-person me-1"></i>Conductor:</strong>
          <%= @delivery_plan.driver&.name.presence || content_tag(:span, "No asignado", class: "text-muted") %></p>
        <p><strong><i class="bi bi-truck-front me-1"></i>Camión:</strong>
          <% if @delivery_plan.truck.present? %>
            <span class="badge bg-dark"><%= @delivery_plan.truck %></span>
          <% else %>
            <span class="text-muted">No asignado</span>
          <% end %></p>
        <p><strong><i class="bi bi-flag me-1"></i>Estado:</strong>
          <span class="badge bg-<%= delivery_plan_status_color(@delivery_plan.status) %>"><%= @delivery_plan.display_status %></span></p>
      </div>
    </div>
  </div>
</div>
<%# ================== ENTREGAS ================== %>
<div class="card shadow-sm mb-4">
  <div class="card-header bg-light fw-bold">
    <i class="bi bi-truck-flatbed me-1"></i> Entregas de este plan
  </div>
  <div class="card-body">
    <% if @delivery_plan.delivery_plan_assignments.any? %>
      <%# ---- TABLA (desktop & tablet) ---- %>
      <div class="table-responsive d-none d-md-block">
        <table class="table table-striped table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th># Parada</th>
              <th>Pedido</th>
              <th>Cliente</th>
              <th>Vendedor</th>
              <th>Dirección</th>
              <th>Hora</th>
              <th>Fecha</th>
              <th>Estado</th>
              <th>Contacto</th>
              <th>Productos</th>
            </tr>
          </thead>
          <tbody>
            <% @delivery_plan.delivery_plan_assignments.order(:stop_order).each do |assignment| %>
              <% delivery = assignment.delivery %>
              <tr>
                <td><span class="badge bg-primary"><%= assignment.stop_order %></span></td>
                <td>
                  <%= link_to delivery.order.number, order_path(delivery.order), class: "fw-bold" %>
                  <% has_notes = delivery.delivery_items.any? { |di| di.notes.present? || di.order_item.notes.present? } %>
                  <% if has_notes %>
                    <span class="badge bg-warning text-dark ms-1">
                      <i class="bi bi-sticky"></i> Nota
                    </span>
                  <% end %>
                </td>
                <td><%= delivery.order.client.name %></td>
                <td><%= delivery.order.seller.seller_code %></td>
                <td>
                  <% if delivery.delivery_address.latitude.present? && delivery.delivery_address.longitude.present? %>
                    <%= link_to [delivery.delivery_address.address, delivery.delivery_address.description].compact.join(" - "),
                          "https://www.google.com/maps?q=#{delivery.delivery_address.latitude},#{delivery.delivery_address.longitude}",
                          target: "_blank", rel: "noopener", class: "text-decoration-none" %>
                  <% else %>
                    <%= link_to [delivery.delivery_address.address, delivery.delivery_address.description].compact.join(" - "),
                          "https://www.google.com/maps/search/?api=1&query=#{ERB::Util.url_encode(delivery.delivery_address.address)}",
                          target: "_blank", rel: "noopener", class: "text-decoration-none" %>
                  <% end %>
                </td>
                <td><%= delivery.delivery_time_preference.presence || "Sin preferencia" %></td>
                <td><%= l delivery.delivery_date, format: :long %></td>
                <td><span class="badge bg-<%= delivery_status_color(delivery.status) %>"><%= delivery.display_status %></span></td>
                <td>
                  <i class="bi bi-telephone me-1"></i>
                  <%= delivery.contact_name %>
                  <% if delivery.contact_phone.present? %>
                    - <%= link_to delivery.contact_phone, "tel:#{delivery.contact_phone}", class: "text-decoration-none" %>
                  <% end %>
                </td>
                <td>
                  <% if delivery.delivery_items.any? %>
                    <div class="d-flex gap-1 flex-wrap">
                      <button class="btn btn-sm btn-outline-info" data-bs-toggle="collapse" data-bs-target="#productosEntrega<%= delivery.id %>">
                        <i class="bi bi-box-seam"></i> Ver productos
                      </button>
                      <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#notaEntregaModal<%= delivery.id %>">
                        <i class="bi bi-sticky"></i> Agregar nota
                      </button>
                    </div>
                  <% else %>
                    <span class="text-muted">Sin productos</span>
                  <% end %>
                </td>
              </tr>
              <% if delivery.delivery_items.any? %>
                <tr class="collapse" id="productosEntrega<%= delivery.id %>">
                  <td colspan="10" class="bg-light">
                    <ul class="mb-0 ps-3 small">
                      <% delivery.delivery_items.each do |item| %>
                        <li>
                          <strong><%= item.order_item.product %></strong>
                          <span class="badge bg-secondary ms-1"><%= item.quantity_delivered %></span>
                          <% if item.notes.present? %>
                            <span class="text-primary ms-1"><i class="bi bi-pin-angle-fill"></i> <em><%= item.notes %></em></span>
                          <% end %>
                          <% if item.order_item.notes.present? %>
                            <span class="text-muted ms-1"><i class="bi bi-info-circle"></i> <%= item.order_item.notes %></span>
                          <% end %>
                        </li>
                      <% end %>
                    </ul>
                  </td>
                </tr>
              <% end %>
            <% end %>
          </tbody>
        </table>
      </div>
      <%# ---- CARDS (mobile) ---- %>
      <div class="d-block d-md-none">
        <div class="row g-2">
          <% @delivery_plan.delivery_plan_assignments.order(:stop_order).each do |assignment| %>
            <% delivery = assignment.delivery %>
            <div class="col-12">
              <div class="card shadow-sm">
                <div class="card-body p-3">
                  <h6 class="fw-bold mb-2">
                    <span class="badge bg-primary">#<%= assignment.stop_order %></span>
                    Pedido: <%= delivery.order.number %>
                  </h6>
                  <p class="mb-1"><i class="bi bi-person me-1"></i><%= delivery.order.client.name %></p>
                  <p class="mb-1"><i class="bi bi-person-badge me-1"></i>Vendedor: <%= delivery.order.seller.seller_code %></p>
                  <p class="mb-1">
                    <i class="bi bi-geo-alt me-1"></i>
                    <% if delivery.delivery_address.latitude.present? && delivery.delivery_address.longitude.present? %>
                      <%= link_to [delivery.delivery_address.address, delivery.delivery_address.description].compact.join(" - "),
                            "https://www.google.com/maps?q=#{delivery.delivery_address.latitude},#{delivery.delivery_address.longitude}",
                            target: "_blank", rel: "noopener", class: "text-decoration-none fw-bold" %>
                    <% else %>
                      <%= link_to [delivery.delivery_address.address, delivery.delivery_address.description].compact.join(" - "),
                            "https://www.google.com/maps/search/?api=1&query=#{ERB::Util.url_encode(delivery.delivery_address.address)}",
                            target: "_blank", rel: "noopener", class: "text-decoration-none fw-bold" %>
                    <% end %>
                  </p>
                  <p class="mb-1"><i class="bi bi-calendar-event me-1"></i><%= l delivery.delivery_date, format: :short %></p>
                  <% if delivery.delivery_time_preference.present? %>
                    <p class="mb-1"><i class="bi bi-clock me-1"></i><%= delivery.delivery_time_preference %></p>
                  <% end %>
                  <p class="mb-1">
                    <i class="bi bi-telephone me-1"></i>
                    <%= delivery.contact_name %>
                    <% if delivery.contact_phone.present? %>
                      - <%= link_to delivery.contact_phone, "tel:#{delivery.contact_phone}", class: "text-decoration-none fw-bold" %>
                    <% end %>
                  </p>
                  <span class="badge bg-<%= delivery_status_color(delivery.status) %>"><%= delivery.display_status %></span>
                  <% has_notes = delivery.delivery_items.any? { |di| di.notes.present? || di.order_item.notes.present? } %>
                  <% if has_notes %>
                    <div class="mt-2">
                      <span class="badge bg-warning text-dark">
                        <i class="bi bi-sticky"></i> Tiene notas
                      </span>
                    </div>
                  <% end %>
                  <% if delivery.delivery_items.any? %>
                    <div class="mt-2">
                      <div class="d-flex gap-1 mb-2">
                        <button class="btn btn-sm btn-outline-info flex-fill" type="button" data-bs-toggle="collapse" data-bs-target="#productosMovil<%= delivery.id %>">
                          <i class="bi bi-box-seam"></i> Ver productos
                        </button>
                        <button class="btn btn-sm btn-outline-primary flex-fill" data-bs-toggle="modal" data-bs-target="#notaEntregaModal<%= delivery.id %>">
                          <i class="bi bi-sticky"></i> Agregar nota
                        </button>
                      </div>
                      <div class="collapse mt-2" id="productosMovil<%= delivery.id %>">
                        <ul class="small ps-3 mb-0">
                          <% delivery.delivery_items.each do |item| %>
                            <li>
                              <strong><%= item.order_item.product %></strong>
                              <span class="badge bg-secondary ms-1"><%= item.quantity_delivered %></span>
                              <% if item.notes.present? %>
                                <br>
                                <span class="text-primary"><i class="bi bi-pin-angle-fill"></i> <em><%= item.notes %></em></span>
                              <% end %>
                            </li>
                          <% end %>
                        </ul>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% else %>
      <div class="alert alert-info"><i class="bi bi-info-circle me-2"></i>No hay entregas asignadas a este plan.</div>
    <% end %>
  </div>
</div>
<%# ================== MODALES PARA NOTAS ================== %>
<% @delivery_plan.delivery_plan_assignments.order(:stop_order).each do |assignment| %>
  <% delivery = assignment.delivery %>
  <% if delivery.delivery_items.any? %>
    <div class="modal fade" id="notaEntregaModal<%= delivery.id %>" tabindex="-1" aria-labelledby="notaEntregaLabel<%= delivery.id %>" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="notaEntregaLabel<%= delivery.id %>">
              <i class="bi bi-sticky me-2"></i> Agregar Nota - Pedido <%= delivery.order.number %>
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <%= form_with url: bulk_add_notes_delivery_items_path, method: :post, local: true do |f| %>
              <%= hidden_field_tag :delivery_id, delivery.id %>
              <div class="mb-3">
                <%= label_tag :target, "Aplicar nota a:", class: "form-label" %>
                <%= select_tag :target,
                      options_for_select([["📌 Nota general (todos los productos)", "all"]] +
                      delivery.delivery_items.map { |i| ["#{i.order_item.product} (#{i.quantity_delivered})", i.id] }),
                      class: "form-select" %>
              </div>
              <div class="mb-3">
                <%= label_tag "note[body]", "Detalle de la nota", class: "form-label" %>
                <%= text_area_tag "note[body]", nil, class: "form-control", rows: 4, placeholder: "Escribe aquí la nota para el conductor o equipo de logística..." %>
              </div>
              <div class="d-flex justify-content-end gap-2">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <%= f.submit "Guardar Nota", class: "btn btn-primary" %>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  <% end %>
<% end %>
<%# ================== MAPA ================== %>
<div class="card shadow-sm mb-4">
  <div class="card-header bg-light fw-bold"><i class="bi bi-map me-2"></i> Mapa de Ruta</div>
  <div class="card-body p-0">
    <div data-controller="delivery-plan-map"
         data-delivery-plan-map-api-key-value="<%= ENV['GOOGLE_MAPS_API_KEY'] %>"
         data-delivery-plan-map-points-value="<%= @assignments.map { |a| {
           id: a.id, stop_order: a.stop_order,
           address: a.delivery.delivery_address.address,
           lat: a.delivery.delivery_address.latitude,
           lng: a.delivery.delivery_address.longitude,
           order_number: a.delivery.order.number,
           client: a.delivery.order.client.name,
           date: l(a.delivery.delivery_date, format: :short)
         } }.to_json %>">
      <div style="height: 420px;" class="border rounded" data-delivery-plan-map-target="map"></div>
    </div>
  </div>
</div>
<%# ================== VOLVER ================== %>
<div class="d-flex">
  <%= link_to delivery_plans_path, class: "btn btn-secondary" do %>
    <i class="bi bi-arrow-left"></i> Volver a Planes de Ruta
  <% end %>
</div>