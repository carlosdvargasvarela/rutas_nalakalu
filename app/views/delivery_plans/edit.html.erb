<h1>Editar orden de paradas - <%= @delivery_plan.full_name %></h1>

<%= form_with model: @delivery_plan, local: true do |f| %>
  <div class="mb-3">
    <%= f.label :driver_id, "Conductor asignado" %>
    <%= f.collection_select :driver_id, User.where(role: :driver), :id, :name, prompt: "Selecciona un conductor", class: "form-select" %>
  </div>

  <table class="table table-sm">
    <thead>
      <tr>
        <th># Parada</th>
        <th>Pedido</th>
        <th>Cliente</th>
        <th>Dirección</th>
        <th>Fecha</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      <% @assignments.each do |assignment| %>
        <tr>
          <td>
            <%= number_field_tag "stop_orders[#{assignment.id}]", assignment.stop_order, min: 1, class: "form-control", style: "width: 80px;" %>
          </td>
          <td><%= assignment.delivery.order.number %></td>
          <td><%= assignment.delivery.order.client.name %></td>
          <td><%= assignment.delivery.delivery_address.address %></td>
          <td><%= l assignment.delivery.delivery_date, format: :short %></td>
          <td>
            <%= form_with url: delivery_plan_delivery_plan_assignment_path(@delivery_plan, assignment), method: :delete, local: true do %>
              <%= submit_tag "Remover", class: "btn btn-sm btn-danger", data: { confirm: "¿Seguro que deseas remover esta entrega del plan?" } %>
            <% end %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
  <%= submit_tag "Guardar cambios", class: "btn btn-primary" %>
  <%= link_to "Cancelar", delivery_plan_path(@delivery_plan), class: "btn btn-secondary" %>
<% end %>

<%# --- Botón fuera del form principal --- %>
<% if @delivery_plan.draft? && @delivery_plan.driver.present? %>
  <%= button_to "Enviar a logística", send_to_logistics_delivery_plan_path(@delivery_plan), method: :patch, class: "btn btn-success mt-3" %>
<% end %>