wb = xlsx_package.workbook

# =====================
# Estilos
# =====================
header_style = wb.styles.add_style(
  bg_color: "4472C4",
  fg_color: "FFFFFF",
  b: true,
  alignment: { horizontal: :center, wrap_text: true }
)

scheduled_style = wb.styles.add_style(
  bg_color: "FFF2CC",
  border: { style: :thin, color: "D6B656" },
  alignment: { wrap_text: true, vertical: :top }
)

ready_style = wb.styles.add_style(
  bg_color: "E2EFDA",
  border: { style: :thin, color: "70AD47" },
  alignment: { wrap_text: true, vertical: :top }
)

confirmed_style = wb.styles.add_style(
  bg_color: "DEEBF7",
  border: { style: :thin, color: "5B9BD5" },
  alignment: { wrap_text: true, vertical: :top }
)

delivered_style = wb.styles.add_style(
  bg_color: "D5E8D4",
  border: { style: :thin, color: "82B366" },
  alignment: { wrap_text: true, vertical: :top }
)

cancelled_style = wb.styles.add_style(
  bg_color: "F8CECC",
  border: { style: :thin, color: "B85450" },
  alignment: { wrap_text: true, vertical: :top }
)

default_style = wb.styles.add_style(
  border: { style: :thin, color: "CCCCCC" },
  alignment: { wrap_text: true, vertical: :top }
)

# =====================
# Hoja
# =====================
wb.add_worksheet(name: "Plan de Ruta") do |sheet|
  # =====================
  # Header
  # =====================
  sheet.add_row [
    "Fecha de entrega",
    "Pedido",
    "Producto",
    "Cantidad",
    "Vendedor",
    "Cliente",
    "Dirección",
    "# Parada",
    "Conductor",
    "Camión",
    "Estado",
    "Hora",
    "Contacto",
    "Notas"
  ], style: header_style

  # =====================
  # Filas de datos
  # =====================
  @assignments.each do |assignment|
    delivery = assignment.delivery

    # Determinar estilo según estado de la entrega
    row_style = case delivery.status&.to_s
                when "scheduled"        then scheduled_style
                when "ready_to_deliver" then ready_style
                when "confirmed"        then confirmed_style
                when "delivered"        then delivered_style
                when "cancelled"        then cancelled_style
                else default_style
                end

    if delivery.active_items_for_plan_for(current_user).empty?
      # Combinar notas para fila sin productos
      all_notes = []
      all_notes << "ENTREGA: #{delivery.delivery_notes}" if delivery.delivery_notes.present?
      notes_text = all_notes.join("\n")

      sheet.add_row [
        delivery.delivery_date.strftime("%d/%m/%Y"),
        delivery.order.number,
        "Sin productos",
        "",
        delivery.order.seller.seller_code,
        delivery.order.client.name,
        [delivery.delivery_address.address, delivery.delivery_address.description].compact.join(" - "),
        assignment.stop_order,
        @delivery_plan.driver&.name || "Sin asignar",
        @delivery_plan.truck || "Sin asignar",
        delivery.display_status,
        delivery.delivery_time_preference.presence || "Sin preferencia",
        "#{delivery.contact_name}#{delivery.contact_phone.present? ? " - #{delivery.contact_phone}" : ""}",
        notes_text
      ], style: row_style

    else
      delivery.active_items_for_plan_for(current_user).each do |delivery_item|
        # Combinar notas con saltos de línea
        all_notes = []
        all_notes << "ENTREGA: #{delivery.delivery_notes}" if delivery.delivery_notes.present?
        all_notes << "PRODUCCIÓN: #{delivery_item.order_item.notes}" if delivery_item.order_item&.notes.present?
        all_notes << "LOGÍSTICA: #{delivery_item.notes}" if delivery_item.notes.present?
        notes_text = all_notes.join("\n")

        sheet.add_row [
          delivery.delivery_date.strftime("%d/%m/%Y"),
          delivery.order.number,
          delivery_item.order_item.product,
          delivery_item.quantity,
          delivery.order.seller.seller_code,
          delivery.order.client.name,
          [delivery.delivery_address.address, delivery.delivery_address.description].compact.join(" - "),
          assignment.stop_order,
          @delivery_plan.driver&.name || "Sin asignar",
          @delivery_plan.truck || "Sin asignar",
          delivery.display_status,
          delivery.delivery_time_preference.presence || "Sin preferencia",
          "#{delivery.contact_name}#{delivery.contact_phone.present? ? " - #{delivery.contact_phone}" : ""}",
          notes_text
        ], style: row_style
      end
    end
  end

  # =====================
  # Ajustes de hoja
  # =====================
  sheet.column_widths 12, 15, 25, 10, 12, 20, 30, 8, 15, 10, 15, 15, 25, 50

  # Combinar celdas de fecha si todas son iguales
  if @assignments.any?
    first_date = @assignments.first.delivery.delivery_date.strftime("%d/%m/%Y")

    if @assignments.all? { |a| a.delivery.delivery_date.strftime("%d/%m/%Y") == first_date }
      total_rows = @assignments.sum { |a| [a.delivery.active_items_for_plan_for(current_user).count, 1].max }
      if total_rows > 1
        sheet.merge_cells("A2:A#{total_rows + 1}")
      end
    end
  end

  # Filtros automáticos
  if @assignments.any?
    total_rows = 1 + @assignments.sum { |a| [a.delivery.active_items_for_plan_for(current_user).count, 1].max }
    sheet.auto_filter = "A1:N#{total_rows}"
  end

  # Congelar primera fila
  sheet.sheet_view.pane do |pane|
    pane.y_split = 1
    pane.state   = :frozen
    pane.top_left_cell = "A2"
  end
end