<div class="container-fluid py-4">
  <%# ================== ENCABEZADO ================== %>
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
    <div>
      <h2 class="mb-1 text-dark fw-bold fs-4">
        <i class="bi bi-map text-primary me-2"></i>Planes de Entrega
      </h2>
      <small class="text-muted">Gestión de rutas semanales de entrega</small>
    </div>
    <div class="d-flex gap-2">
      <%= link_to delivery_plans_path(format: :xlsx), class: "btn btn-outline-success btn-sm d-flex align-items-center gap-2" do %>
        <i class="bi bi-file-earmark-spreadsheet"></i> Exportar Excel
      <% end %>
      <%= link_to new_delivery_plan_path, class: "btn btn-success btn-sm d-flex align-items-center gap-2" do %>
        <i class="bi bi-plus-circle"></i> Nuevo Plan
      <% end %>
    </div>
  </div>
  <%# ================== RESUMEN ================== %>
  <% if @delivery_plans.any? %>
    <div class="alert alert-primary d-flex justify-content-between align-items-center mb-4">
      <div class="d-flex align-items-center gap-3">
        <span>
          <i class="bi bi-info-circle me-1"></i>
          Se encontraron <strong><%= @delivery_plans.to_a.size %></strong> planes de entrega
        </span>
        <span class="badge bg-white text-primary">
          <i class="bi bi-truck me-1"></i>
          <%= @delivery_plans.sum { |plan| plan.deliveries.size } %> entregas totales
        </span>
      </div>
      <div class="d-flex gap-2">
        <% @delivery_plans.group_by(&:status).each do |status, plans| %>
          <% label = status.present? ? status.to_s.humanize : "Sin estado" %>
          <span class="badge bg-<%= delivery_plan_status_color(status || "pending") %>">
            <%= label %>: <%= plans.size %>
          </span>
        <% end %>
      </div>
    </div>
  <% end %>
  <%# ================== FILTROS ================== %>
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-light fw-bold">
      <i class="bi bi-funnel me-2"></i> Filtros de búsqueda
    </div>
    <div class="card-body">
      <%= search_form_for @q, url: delivery_plans_path, method: :get, html: { class: "row g-3 align-items-end" } do |f| %>
        <div class="col-12 col-md-2">
          <%= f.label :first_delivery_date_gteq, "Desde", class: "form-label fw-bold" %>
          <%= f.date_field :first_delivery_date_gteq, class: "form-control" %>
        </div>
        <div class="col-12 col-md-2">
          <%= f.label :first_delivery_date_lteq, "Hasta", class: "form-label fw-bold" %>
          <%= f.date_field :first_delivery_date_lteq, class: "form-control" %>
        </div>
        <div class="col-12 col-md-2">
          <%= f.label :status_eq, "Estado", class: "form-label fw-bold" %>
          <%= f.select :status_eq, 
                options_for_select(DeliveryPlan.statuses.keys.map { |s| [s.humanize, s] }, params.dig(:q, :status_eq)), 
                { include_blank: "Todos los estados" }, 
                { class: "form-select" } %>
        </div>
        <div class="col-12 col-md-2">
          <%= f.label :truck_eq, "Camión", class: "form-label fw-bold" %>
          <%= f.select :truck_eq, 
                options_for_select(DeliveryPlan.distinct.pluck(:truck).compact.map { |t| [t, t] }, params.dig(:q, :truck_eq)), 
                { include_blank: "Todos los camiones" }, 
                { class: "form-select" } %>
        </div>
        <div class="col-12 col-md-2">
          <%= f.label :driver_name_cont, "Conductor", class: "form-label fw-bold" %>
          <%= f.text_field :driver_name_cont, class: "form-control", placeholder: "Buscar conductor..." %>
        </div>
        <div class="col-12 col-md-2 d-flex gap-2">
          <%= f.submit "Buscar", class: "btn btn-primary btn-sm flex-fill" %>
          <%= link_to "Limpiar", delivery_plans_path, class: "btn btn-outline-secondary btn-sm flex-fill" %>
        </div>
      <% end %>
    </div>
  </div>
  <%# ================== TABLA EN DESKTOP ================== %>
  <div class="card shadow-sm d-none d-md-block">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>Semana</th>
              <th>Fechas</th>
              <th>Período</th>
              <th>Estado</th>
              <th>Conductor</th>
              <th>Camión</th>
              <th>Entregas</th>
              <th>Progreso</th>
              <th class="text-center">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <% @delivery_plans.each do |plan| %>
              <% 
                # Validar fechas antes de usar Date.commercial
                if plan.year.present? && plan.week.present?
                  begin
                    start_date = Date.commercial(plan.year.to_i, plan.week.to_i, 1)
                    end_date = Date.commercial(plan.year.to_i, plan.week.to_i, 5)
                  rescue ArgumentError
                    start_date = nil
                    end_date = nil
                  end
                else
                  start_date = nil
                  end_date = nil
                end
                
                delivered_count = plan.deliveries.where(status: :delivered).count
                total_count = plan.deliveries.count
                progress_percentage = total_count > 0 ? (delivered_count.to_f / total_count * 100).round : 0
              %>
              <tr>
                <td>
                  <% if plan.year.present? && plan.week.present? %>
                    <span class="badge bg-primary fs-6">
                      <i class="bi bi-calendar-week me-1"></i>
                      <%= plan.week %> / <%= plan.year %>
                    </span>
                  <% else %>
                    <span class="badge bg-secondary">
                      <i class="bi bi-question-circle me-1"></i>
                      Sin definir
                    </span>
                  <% end %>
                </td>
                <td>
                  <% if plan.deliveries.any? %>
                    <% first_date = plan.deliveries.minimum(:delivery_date) %>
                    <% last_date  = plan.deliveries.maximum(:delivery_date) %>
                    <% if first_date == last_date %>
                      <span class="fw-bold"><%= l first_date, format: :short %></span>
                    <% else %>
                      <div class="d-flex flex-column">
                        <span class="fw-bold"><%= l first_date, format: :short %></span>
                        <small class="text-muted">al <%= l last_date, format: :short %></small>
                      </div>
                    <% end %>
                  <% else %>
                    <span class="text-muted fst-italic">Sin entregas</span>
                  <% end %>
                </td>
                <td>
                  <% if start_date && end_date %>
                    <div class="d-flex flex-column">
                      <span class="fw-bold"><%= l start_date, format: :short %></span>
                      <small class="text-muted">al <%= l end_date, format: :short %></small>
                    </div>
                  <% else %>
                    <span class="text-muted fst-italic">Fechas no definidas</span>
                  <% end %>
                </td>
                <td>
                  <% status_label = plan.status.present? ? plan.display_status : "Sin estado" %>
                  <span class="badge bg-<%= delivery_plan_status_color(plan.status || "pending") %> fs-6">
                    <i class="bi bi-circle-fill small me-1"></i>
                    <%= status_label %>
                  </span>
                </td>
                <td>
                  <% if plan.driver.present? %>
                    <div class="d-flex align-items-center">
                      <i class="bi bi-person-circle text-primary me-2"></i>
                      <span><%= plan.driver.name %></span>
                    </div>
                  <% else %>
                    <span class="text-muted fst-italic">
                      <i class="bi bi-person-dash me-1"></i>Sin asignar
                    </span>
                  <% end %>
                </td>
                <td>
                  <% if plan.truck.present? %>
                    <span class="badge bg-dark">
                      <i class="bi bi-truck-front me-1"></i>
                      <%= plan.truck %>
                    </span>
                  <% else %>
                    <span class="text-muted">—</span>
                  <% end %>
                </td>
                <td>
                  <span class="badge bg-info text-dark fs-6">
                    <i class="bi bi-box-seam me-1"></i>
                    <%= total_count %> entregas
                  </span>
                </td>
                <td>
                  <div class="d-flex align-items-center gap-2">
                    <div class="progress" style="width: 60px; height: 8px;">
                      <div class="progress-bar bg-success" 
                           style="width: <%= progress_percentage %>%"></div>
                    </div>
                    <small class="text-muted"><%= delivered_count %>/<%= total_count %></small>
                  </div>
                </td>
                <td class="text-center">
                  <div class="btn-group">
                    <%= link_to delivery_plan_path(plan), 
                          class: "btn btn-sm btn-outline-primary", 
                          title: "Ver detalles" do %>
                      <i class="bi bi-eye"></i>
                    <% end %>
                    <%= link_to edit_delivery_plan_path(plan), 
                          class: "btn btn-sm btn-outline-secondary", 
                          title: "Editar plan" do %>
                      <i class="bi bi-pencil"></i>
                    <% end %>
                    <button class="btn btn-sm btn-outline-dark dropdown-toggle dropdown-toggle-split" 
                            data-bs-toggle="dropdown" aria-expanded="false">
                      <span class="visually-hidden">Más opciones</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                      <li>
                        <%= link_to delivery_plan_path(plan, format: :pdf), 
                              class: "dropdown-item", target: "_blank" do %>
                          <i class="bi bi-file-earmark-pdf me-2"></i>Descargar PDF
                        <% end %>
                      </li>
                      <li>
                        <%= link_to delivery_plan_path(plan, format: :xlsx), 
                              class: "dropdown-item" do %>
                          <i class="bi bi-file-earmark-spreadsheet me-2"></i>Exportar Excel
                        <% end %>
                      </li>
                      <li><hr class="dropdown-divider"></li>
                      <li>
                        <%= link_to plan, method: :delete, 
                              class: "dropdown-item text-danger", 
                              data: { 
                                confirm: "¿Estás seguro de eliminar este plan de entrega?",
                                turbo_method: :delete
                              } do %>
                          <i class="bi bi-trash me-2"></i>Eliminar
                        <% end %>
                      </li>
                    </ul>
                  </div>
                </td>
              </tr>
            <% end %>
            <% if @delivery_plans.empty? %>
              <tr>
                <td colspan="8" class="text-center text-muted py-5">
                  <div class="d-flex flex-column align-items-center">
                    <i class="bi bi-calendar-x fs-1 text-muted mb-3"></i>
                    <h5 class="text-muted">No hay planes de entrega</h5>
                    <p class="text-muted mb-3">No se encontraron planes que coincidan con los filtros aplicados.</p>
                    <%= link_to new_delivery_plan_path, class: "btn btn-primary" do %>
                      <i class="bi bi-plus-circle me-1"></i>Crear primer plan
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <%# ================== CARDS EN MÓVIL ================== %>
  <div class="d-block d-md-none">
    <div class="row g-3">
      <% @delivery_plans.each do |plan| %>
        <% 
          # Validar fechas antes de usar Date.commercial (móvil)
          if plan.year.present? && plan.week.present?
            begin
              start_date = Date.commercial(plan.year.to_i, plan.week.to_i, 1)
              end_date = Date.commercial(plan.year.to_i, plan.week.to_i, 5)
            rescue ArgumentError
              start_date = nil
              end_date = nil
            end
          else
            start_date = nil
            end_date = nil
          end
          
          delivered_count = plan.deliveries.where(status: :delivered).count
          total_count = plan.deliveries.count
          progress_percentage = total_count > 0 ? (delivered_count.to_f / total_count * 100).round : 0
        %>
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-body p-3">
              <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                  <h6 class="fw-bold mb-1">
                    <% if plan.year.present? && plan.week.present? %>
                      <span class="badge bg-primary">
                        <i class="bi bi-calendar-week me-1"></i>
                        Semana <%= plan.week %> / <%= plan.year %>
                      </span>
                    <% else %>
                      <span class="badge bg-secondary">
                        <i class="bi bi-question-circle me-1"></i>
                        Sin definir
                      </span>
                    <% end %>
                  </h6>
                  <small class="text-muted">
                    <% if start_date && end_date %>
                      <%= l start_date, format: :short %> – <%= l end_date, format: :short %>
                    <% else %>
                      Fechas no definidas
                    <% end %>
                  </small>
                  <small class="text-muted d-block">
                    <% if plan.deliveries.any? %>
                      <% first_date = plan.deliveries.minimum(:delivery_date) %>
                      <% last_date  = plan.deliveries.maximum(:delivery_date) %>
                      <% if first_date == last_date %>
                        Entrega: <%= l first_date, format: :short %>
                      <% else %>
                        Entregas: <%= l first_date, format: :short %> – <%= l last_date, format: :short %>
                      <% end %>
                    <% else %>
                      Sin entregas programadas
                    <% end %>
                  </small>
                </div>
                <% status_label = plan.status.present? ? plan.display_status : "Sin estado" %>
                <span class="badge bg-<%= delivery_plan_status_color(plan.status || "pending") %>">
                  <%= status_label %>
                </span>
              </div>
              <div class="row g-2 mb-3">
                <div class="col-6">
                  <div class="d-flex align-items-center">
                    <i class="bi bi-person-circle text-primary me-2"></i>
                    <div>
                      <small class="text-muted d-block">Conductor</small>
                      <span class="fw-bold"><%= plan.driver&.name || "Sin asignar" %></span>
                    </div>
                  </div>
                </div>
                <div class="col-6">
                  <div class="d-flex align-items-center">
                    <i class="bi bi-truck-front text-dark me-2"></i>
                    <div>
                      <small class="text-muted d-block">Camión</small>
                      <span class="fw-bold"><%= plan.truck || "Sin asignar" %></span>
                    </div>
                  </div>
                </div>
              </div>
              <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="d-flex align-items-center">
                  <i class="bi bi-box-seam text-info me-2"></i>
                  <span><%= total_count %> entregas</span>
                </div>
                <div class="d-flex align-items-center gap-2">
                  <div class="progress" style="width: 80px; height: 8px;">
                    <div class="progress-bar bg-success" 
                         style="width: <%= progress_percentage %>%"></div>
                  </div>
                  <small class="text-muted"><%= delivered_count %>/<%= total_count %></small>
                </div>
              </div>
              <div class="d-flex gap-2">
                <%= link_to delivery_plan_path(plan), 
                      class: "btn btn-sm btn-outline-primary flex-fill" do %>
                  <i class="bi bi-eye me-1"></i>Ver
                <% end %>
                <%= link_to edit_delivery_plan_path(plan), 
                      class: "btn btn-sm btn-outline-secondary flex-fill" do %>
                  <i class="bi bi-pencil me-1"></i>Editar
                <% end %>
                <div class="dropdown">
                  <button class="btn btn-sm btn-outline-dark dropdown-toggle" 
                          data-bs-toggle="dropdown">
                    <i class="bi bi-three-dots"></i>
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end">
                    <li>
                      <%= link_to delivery_plan_path(plan, format: :pdf), 
                            class: "dropdown-item", target: "_blank" do %>
                        <i class="bi bi-file-earmark-pdf me-2"></i>PDF
                      <% end %>
                    </li>
                    <li>
                      <%= link_to delivery_plan_path(plan, format: :xlsx), 
                            class: "dropdown-item" do %>
                        <i class="bi bi-file-earmark-spreadsheet me-2"></i>Excel
                      <% end %>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                      <%= link_to plan, method: :delete, 
                            class: "dropdown-item text-danger", 
                            data: { 
                              confirm: "¿Eliminar este plan?",
                              turbo_method: :delete
                            } do %>
                        <i class="bi bi-trash me-2"></i>Eliminar
                      <% end %>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      <% end %>
      <% if @delivery_plans.empty? %>
        <div class="col-12 text-center py-5">
          <div class="d-flex flex-column align-items-center">
            <i class="bi bi-calendar-x fs-1 text-muted mb-3"></i>
            <h5 class="text-muted">No hay planes de entrega</h5>
            <p class="text-muted mb-3">No se encontraron planes que coincidan con los filtros.</p>
            <%= link_to new_delivery_plan_path, class: "btn btn-primary" do %>
              <i class="bi bi-plus-circle me-1"></i>Crear primer plan
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
  <%# ================== PAGINACIÓN ================== %>
  <% if respond_to?(:paginate) && @delivery_plans.respond_to?(:current_page) %>
    <div class="d-flex justify-content-center mt-4">
      <%= paginate @delivery_plans, theme: 'twitter-bootstrap-4' %>
    </div>
  <% end %>
</div>