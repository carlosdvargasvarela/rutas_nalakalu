<%= form_with url: reschedule_delivery_item_path(item), method: :patch, local: true do |f| %>
  <div class="form-check">
    <%= radio_button_tag "new_delivery", "true", true,
          id: "new_delivery_#{item.id}_true", class: "form-check-input" %>
    <%= label_tag "new_delivery_#{item.id}_true", "Crear nueva entrega",
          class: "form-check-label" %>

    <% if current_user.role == "seller" %>
      <% next_same_weekday = Date.today + 7.days %>
      <%= date_field_tag "new_date", next_same_weekday,
            class: "form-control mt-1",
            data: {
              controller: "weekday-picker",
              weekday_picker_weekday_value: Date.today.wday,
              min: next_same_weekday.strftime("%Y-%m-%d")
            } %>
      <small class="text-muted">
        Solo puedes reagendar para <%= Date::DAYNAMES[Date.today.wday].downcase %>s
      </small>
    <% else %>
      <%= date_field_tag "new_date", Date.today + 7.days,
            class: "form-control mt-1" %>
    <% end %>
  </div>

  <div class="form-check mt-2">
    <%= radio_button_tag "new_delivery", "false", false,
          id: "new_delivery_#{item.id}_false", class: "form-check-input" %>
    <%= label_tag "new_delivery_#{item.id}_false", "Agregar a entrega existente",
          class: "form-check-label" %>
    
    <% if current_user.role == "seller" %>
      <%# Filtrar entregas futuras solo del mismo dÃ­a de la semana %>
      <% seller_allowed_deliveries = future_deliveries.select { |d| d.delivery_date.wday == Date.today.wday } %>
      <%= select_tag "target_delivery_id",
            options_for_select([["Selecciona una entrega existente", ""]] +
              seller_allowed_deliveries.map { |d| ["Entrega ##{d.id} - #{l d.delivery_date, format: :long}", d.id] }),
            class: "form-select mt-1" %>
      <% if seller_allowed_deliveries.empty? %>
        <small class="text-muted">No hay entregas existentes para <%= Date::DAYNAMES[Date.today.wday].downcase %>s</small>
      <% end %>
    <% else %>
      <%= select_tag "target_delivery_id",
            options_for_select([["Selecciona una entrega existente", ""]] +
              future_deliveries.map { |d| ["Entrega ##{d.id} - #{l d.delivery_date, format: :long}", d.id] }),
            class: "form-select mt-1" %>
    <% end %>
  </div>

  <%= f.submit "Reagendar", class: "btn btn-warning btn-sm mt-2" %>
<% end %>