<% delivery = assignment.delivery %>
<div class="card shadow-sm" 
     data-assignment-id="<%= assignment.id %>"
     data-offline-queue-target="card">
  <div class="card-body">
    <!-- Header con stop order y número de pedido -->
    <div class="d-flex justify-content-between align-items-start mb-2">
      <h6 class="fw-bold mb-0">
        <span class="badge bg-primary me-1">#<%= assignment.stop_order %></span>
        Pedido: <%= delivery.order.number %>
      </h6>
      <span class="badge bg-<%= assignment_status_badge_class(assignment.status) %>">
        <%= assignment.display_status %>
      </span>
    </div>
    <!-- Cliente -->
    <p class="mb-2">
      <i class="bi bi-person me-1 text-muted"></i>
      <strong><%= delivery.order.client.name %></strong>
    </p>
    <!-- Dirección con Waze -->
    <p class="mb-2">
      <i class="bi bi-geo-alt-fill me-1 text-danger"></i>
      <% if delivery.delivery_address.latitude.present? && delivery.delivery_address.longitude.present? %>
        <%= link_to "#{delivery.delivery_address.address}#{' - ' + delivery.delivery_address.description if delivery.delivery_address.description.present?}",
                    "https://waze.com/ul?ll=#{delivery.delivery_address.latitude},#{delivery.delivery_address.longitude}&navigate=yes",
                    target: "_blank", 
                    rel: "noopener", 
                    class: "text-decoration-none fw-bold text-primary" %>
      <% else %>
        <%= link_to "#{delivery.delivery_address.address}#{' - ' + delivery.delivery_address.description if delivery.delivery_address.description.present?}",
                    "https://waze.com/ul?q=#{ERB::Util.url_encode(delivery.delivery_address.address)}&navigate=yes",
                    target: "_blank", 
                    rel: "noopener", 
                    class: "text-decoration-none fw-bold text-primary" %>
      <% end %>
    </p>
    <!-- Fecha -->
    <p class="mb-2">
      <i class="bi bi-calendar-event me-1 text-muted"></i>
      <%= l delivery.delivery_date, format: :short %>
    </p>
    <!-- Hora preferida -->
    <p class="mb-2">
      <i class="bi bi-clock me-1 text-muted"></i>
      <%= delivery.delivery_time_preference.presence || "Sin preferencia horaria" %>
    </p>
    <!-- Contacto y teléfono -->
    <p class="mb-2">
      <i class="bi bi-telephone me-1 text-muted"></i>
      <%= delivery.contact_name %>
      <% if delivery.contact_phone.present? %>
        - <%= link_to delivery.contact_phone, "tel:#{delivery.contact_phone}", class: "text-decoration-none" %>
      <% end %>
    </p>
    <!-- Notas de entrega (si existen) -->
    <% if delivery.delivery_notes.present? %>
      <div class="alert alert-info py-2 px-3 mb-2 small">
        <i class="bi bi-sticky me-1"></i>
        <strong>Notas:</strong> <%= delivery.delivery_notes %>
      </div>
    <% end %>
    <!-- Productos colapsables -->
    <% if delivery.delivery_items.any? %>
      <div class="mt-3">
        <button class="btn btn-sm btn-outline-info w-100"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#productos<%= assignment.id %>">
          <i class="bi bi-box-seam me-1"></i>
          Ver productos (<%= delivery.active_items_for_plan_for(current_user).sum(&:quantity) %>)
        </button>
        <div class="collapse mt-2" id="productos<%= assignment.id %>">
          <ul class="list-group list-group-flush small">
            <% delivery.active_items_for_plan_for(current_user).each do |item| %>
              <li class="list-group-item px-0">
                <div class="d-flex justify-content-between align-items-start">
                  <strong><%= item.order_item.product %></strong>
                  <span class="badge bg-secondary"><%= item.quantity %></span>
                </div>
                <% if item.notes.present? %>
                  <div class="text-primary mt-1">
                    <i class="bi bi-pin-angle-fill me-1"></i>
                    <em><%= item.notes %></em>
                  </div>
                <% end %>
                <% if item.order_item.notes.present? %>
                  <div class="text-muted mt-1">
                    <i class="bi bi-info-circle me-1"></i>
                    <%= item.order_item.notes %>
                  </div>
                <% end %>
              </li>
            <% end %>
          </ul>
        </div>
      </div>
    <% end %>
    <!-- Botones de acción -->
    <div class="d-grid gap-2 mt-3">
      <% if assignment.pending? %>
        <%= button_tag type: "button",
                       class: "btn btn-success",
                       data: {
                         action: "click->offline-queue#markDelivered",
                         assignment_id: assignment.id,
                         offline_queue_target: "deliveredBtn"
                       } do %>
          <i class="bi bi-check-circle me-1"></i>Marcar como entregado
        <% end %>
        <%= button_tag type: "button",
                       class: "btn btn-warning",
                       data: {
                         action: "click->offline-queue#markPending",
                         assignment_id: assignment.id,
                         offline_queue_target: "pendingBtn"
                       } do %>
          <i class="bi bi-clock-history me-1"></i>Marcar como pendiente
        <% end %>
      <% end %>
      <!-- Botón para agregar nota -->
      <button type="button" 
              class="btn btn-outline-primary btn-sm"
              data-bs-toggle="modal"
              data-bs-target="#notaModal<%= assignment.id %>">
        <i class="bi bi-sticky me-1"></i>Agregar nota de entrega
      </button>
    </div>
  </div>
</div>
<!-- Modal para agregar nota -->
<div class="modal fade" id="notaModal<%= assignment.id %>" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-sticky me-2"></i>
          Nota para pedido <%= delivery.order.number %>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <textarea class="form-control" 
                  rows="4" 
                  placeholder="Escribe aquí cualquier observación sobre la entrega..."
                  data-offline-queue-target="notesTextarea"
                  data-assignment-id="<%= assignment.id %>"></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" 
                class="btn btn-primary"
                data-action="click->offline-queue#saveNote"
          data-assignment-id="<%= assignment.id %>"
          data-bs-dismiss="modal">
          <i class="bi bi-save me-1"></i>Guardar nota
        </button>
      </div>
    </div>
  </div>
</div>