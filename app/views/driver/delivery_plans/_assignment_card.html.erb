<% delivery = assignment.delivery %>
<div class="card shadow-sm" 
     id="assignment_<%= assignment.id %>"
     data-controller="driver-assignment"
     data-driver-assignment-plan-id-value="<%= delivery_plan.id %>"
     data-driver-assignment-assignment-id-value="<%= assignment.id %>">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-start mb-2">
      <h6 class="fw-bold mb-0">
        <span class="badge bg-primary me-1">#<%= assignment.stop_order %></span>
        Pedido: <%= delivery.order.number %>
      </h6>
      <span class="badge bg-<%= assignment_status_badge_class(assignment.status) %>" 
            data-driver-assignment-target="statusBadge">
        <%= assignment.display_status %>
      </span>
    </div>
    <!-- ... resto igual ... -->
    <div class="d-grid gap-2 mt-3" data-driver-assignment-target="actions">
      <% if assignment.pending? %>
        <button type="button" class="btn btn-success" data-action="click->driver-assignment#start">
          <i class="bi bi-play-circle me-1"></i>Iniciar entrega
        </button>
        <button type="button" class="btn btn-warning" data-action="click->driver-assignment#markFailed">
          <i class="bi bi-exclamation-triangle me-1"></i>Marcar como fallida
        </button>
      <% elsif assignment.en_route? %>
        <button type="button" class="btn btn-primary" data-action="click->driver-assignment#complete">
          <i class="bi bi-check-circle me-1"></i>Completar entrega
        </button>
        <button type="button" class="btn btn-warning" data-action="click->driver-assignment#markFailed">
          <i class="bi bi-exclamation-triangle me-1"></i>Marcar como fallida
        </button>
      <% elsif assignment.completed? %>
        <div class="alert alert-success mb-0 py-2">
          <i class="bi bi-check-circle-fill me-1"></i>
          Entrega completada
        </div>
      <% elsif assignment.cancelled? %>
        <div class="alert alert-danger mb-0 py-2">
          <i class="bi bi-x-circle-fill me-1"></i>
          Entrega cancelada
        </div>
      <% end %>
      <button type="button" 
              class="btn btn-outline-primary btn-sm"
              data-action="click->driver-assignment#openNoteModal">
        <i class="bi bi-sticky me-1"></i>Agregar nota
      </button>
    </div>
  </div>
</div>
<!-- Modal para agregar nota -->
<div class="modal fade" id="notaModal<%= assignment.id %>" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-sticky me-2"></i>
          Nota para pedido <%= delivery.order.number %>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <textarea class="form-control" 
                  rows="4" 
                  placeholder="Escribe aquí cualquier observación sobre la entrega..."
                  data-driver-assignment-target="noteTextarea"></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" 
                class="btn btn-primary"
                data-action="click->driver-assignment#saveNote"
          data-bs-dismiss="modal">
          <i class="bi bi-save me-1"></i>Guardar nota
        </button>
      </div>
    </div>
  </div>
</div>