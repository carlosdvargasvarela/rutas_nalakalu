<% delivery = assignment.delivery %>
<div class="col-12" id="assignment_<%= assignment.id %>">
  <div class="card shadow-sm">
    <div class="card-body p-3">
      <h6 class="fw-bold mb-2">
        <span class="badge bg-primary">#<%= assignment.stop_order %></span>
        Pedido: <%= delivery.order.number %>
        <span class="badge <%= assignment.completed? ? 'bg-success' : assignment.en_route? ? 'bg-info' : 'bg-secondary' %> ms-2">
          <%= assignment.status.humanize %>
        </span>
      </h6>
      <p><i class="bi bi-person me-1"></i><%= delivery.order.client.name %></p>
      <p>
        <% if delivery.delivery_address.latitude.present? && delivery.delivery_address.longitude.present? %>
          <%= link_to [delivery.delivery_address.address, delivery.delivery_address.description].compact.join(" - "),
                      "https://waze.com/ul?ll=#{delivery.delivery_address.latitude},#{delivery.delivery_address.longitude}&navigate=yes",
                      target: "_blank", rel: "noopener", class: "text-decoration-none fw-bold text-primary" %>
        <% else %>
          <%= link_to [delivery.delivery_address.address, delivery.delivery_address.description].compact.join(" - "),
                      "https://waze.com/ul?q=#{ERB::Util.url_encode(delivery.delivery_address.address)}&navigate=yes",
                      target: "_blank", rel: "noopener", class: "text-decoration-none fw-bold text-primary" %>
        <% end %>
      </p>
      <p><i class="bi bi-calendar-event me-1"></i><%= l delivery.delivery_date, format: :short %></p>
      <p><i class="bi bi-clock me-1"></i><%= delivery.delivery_time_preference.presence || "Sin preferencia" %></p>
      <p><i class="bi bi-telephone me-1"></i><%= delivery.contact_name %>
        <%= link_to delivery.contact_phone, "tel:#{delivery.contact_phone}" if delivery.contact_phone.present? %>
      </p>
      <p>
        <strong><i class="bi bi-flag me-1"></i>Estado entrega:</strong>
        <span class="badge bg-<%= delivery_status_color(delivery.status) %>"><%= delivery.display_status %></span>
      </p>
      <div class="small text-muted">
        <% if assignment.started_at.present? %>
          <i class="bi bi-play-circle me-1"></i> Iniciada: <%= l assignment.started_at, format: :short %>
        <% end %>
        <% if assignment.completed_at.present? %>
          <span class="ms-3"><i class="bi bi-check-circle me-1"></i> Completada: <%= l assignment.completed_at, format: :short %></span>
        <% end %>
      </div>
      <% if delivery.delivery_notes.present? %>
        <p>
          <strong><i class="bi bi-sticky me-1"></i>Notas de Entrega:</strong>
          <span class="text-muted small"><%= delivery.delivery_notes %></span>
        </p>
      <% end %>
      <% if delivery.delivery_items.any? %>
        <div class="mt-2 d-flex gap-1">
          <button class="btn btn-sm btn-outline-info flex-fill"
              data-bs-toggle="collapse"
              data-bs-target="#productosMovil<%= delivery.id %>">
            <i class="bi bi-box-seam"></i> Ver productos
          </button>
          <!-- Nota del chofer: inline, sin modal -->
          <button class="btn btn-sm btn-outline-primary"
              data-bs-toggle="collapse"
              data-bs-target="#notaChofer<%= assignment.id %>">
            <i class="bi bi-journal-text"></i> Nota chofer
          </button>
        </div>
        <div class="collapse mt-2" id="productosMovil<%= delivery.id %>">
          <ul class="small ps-3 mb-0">
            <% delivery.active_items_for_plan_for(current_user).each do |item| %>
              <li>
                <strong><%= item.order_item.product %></strong>
                <span class="badge bg-secondary ms-1"><%= item.quantity %></span>
                <% if item.notes.present? %>
                  <br>
                  <span class="text-primary"><i class="bi bi-pin-angle-fill"></i> <em><%= item.notes %></em></span>
                <% end %>
                <% if item.order_item.notes.present? %>
                  <br>
                  <span class="text-muted"><i class="bi bi-info-circle"></i> <%= item.order_item.notes %></span>
                <% end %>
              </li>
            <% end %>
          </ul>
        </div>
      <% end %>
      <!-- Acciones del chofer -->
      <div class="mt-3 d-flex gap-2 flex-wrap">
        <% unless assignment.en_route? || assignment.completed? %>
          <%= button_to "Iniciar parada", start_driver_delivery_plan_assignment_path(assignment.delivery_plan, assignment),
                method: :patch,
                class: "btn btn-outline-info btn-sm",
                form: { data: { turbo_stream: true } } %>
        <% end %>
        <% unless assignment.completed? || assignment.cancelled? %>
          <%= button_to "Marcar entregada", complete_driver_delivery_plan_assignment_path(assignment.delivery_plan, assignment),
                method: :patch,
                class: "btn btn-success btn-sm",
                data: { turbo_confirm: "¿Confirmar entrega completa?" },
                form: { data: { turbo_stream: true } } %>
        <% end %>
        <% unless assignment.completed? || assignment.cancelled? %>
          <button class="btn btn-outline-danger btn-sm"
            data-bs-toggle="collapse"
            data-bs-target="#markFailed<%= assignment.id %>">
            <i class="bi bi-x-circle"></i> Entrega fracasada
          </button>
        <% end %>
      </div>
      <!-- Form entrega fracasada -->
      <div class="collapse mt-2" id="markFailed<%= assignment.id %>">
        <%= form_with url: mark_failed_driver_delivery_plan_assignment_path(assignment.delivery_plan, assignment),
              method: :patch, data: { turbo_stream: true }, class: "row g-2" do |f| %>
          <div class="col-12">
            <label class="form-label small">Motivo del fracaso (opcional):</label>
            <textarea name="reason" rows="2" class="form-control" placeholder="Ej: Cliente no estaba, dirección incorrecta, etc."></textarea>
          </div>
          <div class="col-12 d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="collapse" data-bs-target="#markFailed<%= assignment.id %>">Cancelar</button>
            <button class="btn btn-danger btn-sm" data-turbo-confirm="¿Confirmar que la entrega fracasó? Se creará una nueva entrega para una semana después.">
              Confirmar fracaso
            </button>
          </div>
        <% end %>
      </div>
      <!-- Form nota chofer (Turbo Stream) -->
      <div class="collapse mt-2" id="notaChofer<%= assignment.id %>">
        <%= form_with url: note_driver_delivery_plan_assignment_path(assignment.delivery_plan, assignment),
              method: :patch, data: { turbo_stream: true }, class: "row g-2" do |f| %>
          <div class="col-12">
            <textarea name="note" rows="2" class="form-control" placeholder="Escribe una nota para esta parada..."></textarea>
          </div>
          <div class="col-12 d-flex justify-content-end">
            <button class="btn btn-primary btn-sm">Guardar nota</button>
          </div>
        <% end %>
        <% if assignment.driver_notes.present? %>
          <div class="small mt-2 text-muted">
            <i class="bi bi-journal-text me-1"></i> <%= simple_format assignment.driver_notes %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>